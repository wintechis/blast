var de=Object.create;var T=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames;var he=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var we=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ge=(t,e)=>{for(var r in e)T(t,r,{get:e[r],enumerable:!0})},M=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of fe(e))!be.call(t,i)&&i!==r&&T(t,i,{get:()=>e[i],enumerable:!(n=pe(e,i))||n.enumerable});return t};var g=(t,e,r)=>(r=t!=null?de(he(t)):{},M(e||!t||!t.__esModule?T(r,"default",{value:t,enumerable:!0}):r,t)),me=t=>M(T({},"__esModule",{value:!0}),t);var B=we((bt,te)=>{var ve=Object.create,C=Object.defineProperty,ye=Object.getOwnPropertyDescriptor,Ee=Object.getOwnPropertyNames,Se=Object.getPrototypeOf,De=Object.prototype.hasOwnProperty,Ie=(t,e)=>{for(var r in e)C(t,r,{get:e[r],enumerable:!0})},K=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ee(e))!De.call(t,i)&&i!==r&&C(t,i,{get:()=>e[i],enumerable:!(n=ye(e,i))||n.enumerable});return t},Re=(t,e,r)=>(r=t!=null?ve(Se(t)):{},K(e||!t||!t.__esModule?C(r,"default",{value:t,enumerable:!0}):r,t)),Te=t=>K(C({},"__esModule",{value:!0}),t),Y={};Ie(Y,{BluetoothAdapter:()=>Fe,EddystoneHelpers:()=>Qe,HidAdapter:()=>je,default:()=>Ze});te.exports=Te(Y);var m=require("@node-wot/core"),L=require("@node-wot/core/dist/interaction-output.js"),Ae=require("json-placeholder-replacer"),F=require("@node-wot/binding-http"),ft=require("@node-wot/td-tools"),H=require("@node-wot/core"),Ce=require("rxjs"),x=require("stream"),{debug:h}=(0,H.createLoggers)("binding-bluetooth","gatt-client"),Be=class{bluetoothAdapter;subscriptions;constructor(t){h("created client"),this.bluetoothAdapter=t,this.subscriptions=new Map}toString(){return"[GattClient]"}async readResource(t){let e=this.deconstructForm(t),r=await this.bluetoothAdapter.getCharacteristic(e.deviceId,e.serviceId,e.characteristicId);h(`invoking "readValue" on characteristic ${e.characteristicId}`);let n=await r.readValue(),i;t["bdo:signed"]?i=new Int8Array(n.buffer):i=new Uint8Array(n.buffer),h(`Received value: ${i}`);let a=x.Readable.from(i);return{type:t.contentType??"application/x.binary-data-stream",body:a,toBuffer:()=>H.ProtocolHelpers.readStreamFully(a)}}async writeResource(t,e){let r=this.deconstructForm(t),n;if(typeof e<"u"){let a=await e.toBuffer();n=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength)}else n=new ArrayBuffer(1);let i=await this.bluetoothAdapter.getCharacteristic(r.deviceId,r.serviceId,r.characteristicId);switch(r.bleOperation){case"sbo:write-without-response":h(`invoking "writeValueWithoutResponse" on characteristic ${r.characteristicId}`),await i.writeValueWithoutResponse(n),h("writeValueWithoutResponse done");break;case"sbo:write":h(`invoking "writeValueWithResponse" on characteristic ${r.characteristicId}`),await i.writeValueWithResponse(n),h("writeValueWithResponse done");break;default:throw new Error(`unknown operation ${r["sbo:methodName"]}`)}}invokeResource(t,e){return this.writeResource(t,e).then(()=>Promise.resolve({type:"application/json",body:new x.Readable,toBuffer:async()=>Buffer.from([])}))}unlinkResource(t){let e=this.subscriptions.get(t.href);return e&&e.unsubscribe(),Promise.resolve()}async subscribeResource(t,e,r){let{deviceId:n,serviceId:i,characteristicId:a,bleOperation:s}=this.deconstructForm(t);if(s!=="sbo:notify"&&s!=="sbo:subscribe")throw new Error(`operation ${s} is not supported`);h(`subscribing to characteristic with serviceId ${i} characteristicId ${a}`);let o=l=>{h(`Received "characteristicvaluechanged" event: ${l}`);let d=l.target.value,f;t["bdo:signed"]?f=new Int8Array(d.buffer):f=new Uint8Array(d.buffer);let w=x.Readable.from(f);e({type:t.contentType??"application/x.binary-data-stream",body:w,toBuffer:()=>H.ProtocolHelpers.readStreamFully(w)})},c=await this.bluetoothAdapter.getCharacteristic(n,i,a);c.addEventListener("characteristicvaluechanged",o),await c.startNotifications();let u=new Ce.Subscription(()=>{c.stopNotifications(),c.removeEventListener("characteristicvaluechanged",o)});return this.subscriptions.set(t.href,u),u}async start(){}async stop(){h("Stopping client");for(let t of this.subscriptions.values())t.unsubscribe();this.subscriptions.clear()}setSecurity(){return!1}async requestThingDescription(t){throw new Error("BluetoothClient does not implement TD retrieval")}deconstructForm=function(t){let e={};e.path=t.href.split("://")[1];let r=e.path.split("/");if(r.length!==3){let n=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/,i=r[0];for(let a=1;a<r.length;a++)n.test(r[a])===!1?i=i+"/"+r[a]:(a===r.length-2&&(e.serviceId=r[a]),a===r.length-1&&(e.characteristicId=r[a]));e.deviceId=i}else e.deviceId=r[0],e.serviceId=r[1],e.characteristicId=r[2];return e.operation=t.op?.toString()??"",e.bleOperation=t["sbo:methodName"],e}},Q=require("@node-wot/core"),Pe=Re(require("uritemplate"),1),Le=class{getMediaType(){return"application/x.binary-data-stream"}bytesToValue(t,e){let r=null,n,i;if(typeof e["bdo:pattern"]<"u"){let a=xe(e,t);n=a[0],i=a[1];let s=[];for(let o=0;o<n.length;o++){let c=e["bdo:variables"][n[o]],u=i[o];switch(c.type){case"integer":case"number":s.push(V(c,u));break;case"string":s.push(q(c,u));break;case"object":s.push(N(c,u));break;default:throw new Error("Datatype not supported by codec")}r=s}}else switch(e.type){case"integer":case"number":r=V(e,t);break;case"string":r=q(e,t);break;case"object":r=N(e,t);break;default:throw new Error(`Datatype ${e.type} not supported by codec`)}return r}valueToBytes(t,e){let r=Buffer.alloc(1),n;if(typeof e["bdo:pattern"]<"u")n=$e(e,t),r=W(e,n);else switch(e.type){case"number":case"integer":r=X(e,t);break;case"string":r=W(e,t);break;case"object":case"array":r=ke(e,t);break}if(typeof e["tst:function"]<"u"){let i=e["tst:function"];r=new Function("buf",i)(r)}return r}};function V(t,e){let r=t["bdo:bytelength"]??e.byteLength,n=t["bdo:signed"]??!1,i=t["bdo:byteOrder"]??"little",a=t["bdo:scale"]??1,s=t["bdo:offset"]??0,o=t["bdo:precision"]??2;if(typeof r>"u")throw new Error("Not all parameters are provided!");let c=0;return i==="little"?n?c=e.readIntLE(s,r):c=e.readUIntLE(s,r):i==="big"&&(n?c=e.readIntBE(s,r):c=e.readUIntBE(s,r)),c=c*a,c=+(Math.round(+(c+"e+"+o))+"e-"+o),c}function X(t,e){let r=t["bdo:bytelength"],n=t["bdo:signed"]??!1,i=t["bdo:byteOrder"]??"little",a=t["bdo:scale"]??1,s=t["bdo:offset"]??0;if(typeof r>"u")throw new Error("Not all parameters are provided!");e=e*a;let o=Buffer.alloc(r);return i==="little"?n?o.writeIntLE(e,s,r):o.writeUIntLE(e,s,r):i==="big"&&(n?o.writeIntBE(e,s,r):o.writeUIntBE(e,s,r)),o}function xe(t,e){let r=t["bdo:pattern"],n=t["bdo:variables"],i=[],a=[],s=r.split("{");for(let u=0;u<s.length;u++){let l=s[u].split("}");u===0?i.push(l[0].length/2):(a.push(l[0]),i.push(l[1].length/2))}let o=[],c=0+i[0];for(let u=0;u<a.length;u++){let l=n[a[u]]["bdo:bytelength"];o.push(e.subarray(c,c+l)),c+=l+i[u+1]}return[a,o]}function $e(t,e){let r,n;for([r,n]of Object.entries(t["bdo:variables"]))if(n.type==="integer"){let i=X(n,e[r]);e[r]=i.toString("hex")}return Pe.parse(t["bdo:pattern"]).expand(e)}function W(t,e){let r;if(typeof t.format>"u")return r=Buffer.from(e,"utf-8"),r;if(t.format==="hex")return r=Buffer.from(e,"hex"),r;throw Error("String can not be converted to bytes, format not supported")}function q(t,e){let r;if(typeof t.format>"u"?r=e.toString("utf-8"):t.format==="hex"&&(r=e.toString("hex")),typeof r>"u")throw Error("String can not be converted to bytes, format not supported");return r}function N(t,e){let r=e.toString("utf-8");return JSON.parse(r)}function ke(t,e){let r;return Array.isArray(e)&&e.every(n=>typeof n=="number")?r=Buffer.from(e):r=Buffer.from(JSON.stringify(e)),r}var{debug:j}=(0,Q.createLoggers)("binding-bluetooth","gatt-client-factory"),He=class{scheme="gatt";clients=new Set;contentSerdes=Q.ContentSerdes.get();adapter;constructor(t){this.contentSerdes.addCodec(new Le),this.adapter=t}getClient(){j(`Creating client for ${this.scheme}`);let t=new Be(this.adapter);return this.clients.add(t),t}destroy(){return j(`stopping all clients for '${this.scheme}'`),this.clients.forEach(t=>t.stop()),!0}init=()=>!0},Z=require("@node-wot/core"),ee=require("@node-wot/core"),Oe=require("rxjs"),G=require("stream"),{debug:$}=(0,ee.createLoggers)("binding-bluetooth","gap-client"),Ue=class{bluetoothAdapter;subscriptions;constructor(t){$("created client"),this.bluetoothAdapter=t,this.subscriptions=new Map}toString(){return"[GapClient]"}async readResource(t){throw new Error("Method not implemented.")}async writeResource(t,e){throw new Error("Method not implemented.")}async invokeResource(t,e){throw new Error("Method not implemented.")}async unlinkResource(t){throw new Error("Method not implemented.")}subscribeResource(t,e,r){let n=async a=>{$(`Received GAP broadcast: ${a.target.manufacturerData[0].data}`);let s=a.target.manufacturerData[0].data;e({type:t.contentType??"application/x.binary-data-stream",body:G.Readable.from(s),toBuffer:()=>ee.ProtocolHelpers.readStreamFully(G.Readable.from(s))})},i=t.href.split("/")[2];return this.bluetoothAdapter.observeGAP(i,n),Promise.resolve(new Oe.Subscription)}async requestThingDescription(t){throw new Error("BluetoothClient does not implement TD retrieval")}async start(){}async stop(){$("Stopping client");for(let t of this.subscriptions.values())t.unsubscribe();this.subscriptions.clear()}setSecurity(){return!1}},{debug:_}=(0,Z.createLoggers)("binding-bluetooth","gap-client-factory"),Me=class{scheme="gap";clients=new Set;contentSerdes=Z.ContentSerdes.get();adapter;constructor(t){this.adapter=t}getClient(){_(`Creating client for ${this.scheme}`);let t=new Ue(this.adapter);return this.clients.add(t),t}destroy(){return _(`stopping all clients for '${this.scheme}'`),this.clients.forEach(t=>t.stop()),!0}init=()=>!0},Fe=class{},ht=require("@node-wot/td-tools"),A=require("@node-wot/core"),Ve=require("rxjs/Subscription.js"),k=require("stream"),{debug:b}=(0,A.createLoggers)("binding-hid","hid-client"),We=class{hidAdapter;subscriptions;constructor(t){b("created client"),this.hidAdapter=t,this.subscriptions=new Map}toString(){return"[Hid Client]"}async readResource(t){let e=t["hid:path"],r=await this.hidAdapter.getDevice(e),n=t["hid:reportId"],i=t["hid:reportLength"];if(n===void 0)throw new Error("Report ID cannot be undefined");if(i===void 0)throw new Error("Report length cannot be undefined");let a=await r.receiveFeatureReport(n),s;t.signed?s=new Int8Array(a.buffer):s=new Uint8Array(a.buffer);let o=k.Readable.from(s);return{type:t.contentType||"application/octet-stream",body:o,toBuffer:()=>A.ProtocolHelpers.readStreamFully(o)}}async writeResource(t,e){let r=t["hid:path"],n=await this.hidAdapter.getDevice(r),i=t.href.split("://")[1].split("/")[0],a=await e.toBuffer(),s;if(t["hid:data"]!==void 0){s=t["hid:data"];let c;t.signed?c=new Int8Array(a)[a.length-1]:c=new Uint8Array(a)[a.length-1],t["hid:valueIndex"]!==void 0&&(s[t["hid:valueIndex"]]=c)}else s=new Uint8Array(a);let o=t["hid:reportId"]||s[0];if(s=Buffer.from(s),i==="sendFeatureReport")b(`Sending feature report: ${o} ${s}`),await n.sendFeatureReport(o,s);else if(i==="sendReport")b(`Sending report: ${o} ${s}`),await n.sendReport(o,Buffer.from(s.subarray(1)));else throw new Error(`Method ${i} is not supported`)}async invokeResource(t,e){return await this.writeResource(t,e),Promise.resolve(new A.Content(t.contentType??"application/octet-stream",k.Readable.from([])))}unlinkResource(t){let e=this.subscriptions.get(t["hid:path"]);return e&&e.unsubscribe(),Promise.resolve()}async subscribeResource(t,e,r,n){let i=t["hid:path"],a=await this.hidAdapter.getDevice(i);b(`Subscribing to device:  ${i}`);let s=c=>{b(`Received "inputreport" event with report id: ${c.reportId} and data: ${c.data.buffer}`);let u;t.signed?u=new Int8Array(c.data.buffer):u=new Uint8Array(c.data.buffer);let l=k.Readable.from(u),d=new A.Content(t.contentType||"application/x.binary-data-stream",l);e(d)};a.addEventListener("inputreport",s);let o=new Ve.Subscription(()=>{b("Removing 'inputreport' listener from device: ${id}"),a.removeEventListener("inputreport",s)});return this.subscriptions.set(i,o),o}async start(){}async stop(){b("Stopping client");for(let t of this.subscriptions.values())t.unsubscribe();this.subscriptions.clear()}async requestThingDescription(t){throw new Error("HidClient does not implement TD retrieval")}setSecurity(){return!1}},qe=require("@node-wot/core"),{debug:z}=(0,qe.createLoggers)("binding-hid","hid-client-factory"),Ne=class{scheme="hid";clients=new Set;adapter;constructor(t){this.adapter=t}getClient(){z(`Creating client for ${this.scheme}`);let t=new We(this.adapter);return this.clients.add(t),t}destroy(){return z(`stopping all clients for '${this.scheme}'`),this.clients.forEach(t=>t.stop()),!0}init=()=>!0},je=class{},Ge="a3c87500-8ed3-4bdf-8a39-a01bebede295",_e={"a3c87501-8ed3-4bdf-8a39-a01bebede295":"Capabilities","a3c87502-8ed3-4bdf-8a39-a01bebede295":"Active Slot","a3c87503-8ed3-4bdf-8a39-a01bebede295":"Advertising Interval","a3c87504-8ed3-4bdf-8a39-a01bebede295":"Radio Tx Power","a3c87505-8ed3-4bdf-8a39-a01bebede295":"Advertised Tx Power","a3c87506-8ed3-4bdf-8a39-a01bebede295":"Lock State","a3c87507-8ed3-4bdf-8a39-a01bebede295":"Unlock","a3c87508-8ed3-4bdf-8a39-a01bebede295":"Public ECDH Key","a3c87509-8ed3-4bdf-8a39-a01bebede295":"EID Identity Key","a3c8750a-8ed3-4bdf-8a39-a01bebede295":"Adv Slot Data","a3c8750b-8ed3-4bdf-8a39-a01bebede295":"Factory Reset"},ze=function(t,e){let r={mask:8*Math.pow(16,e-1),sub:-1*Math.pow(16,e)};return(parseInt(t,16)&r.mask)>0?r.sub+parseInt(t,16):parseInt(t,16)},Je=function(t){let e=[];for(let n=0;n<t.length;n+=2)e.push(ze(t.substring(n,n+2),2));let r=[];for(let n=6;n<e.length;n++){let i=r[r.length-1];if(i&&i>=e[n])break;r.push(e[n])}return{specVersion:e[0],maxSlots:e[1],maxEidPerSlot:e[2],isVarriableAdvIntervalSupported:(e[3]&1)!==0,isVariableTxPowerSupported:(e[3]&2)!==0,isUidSupported:(e[5]&1)!==0,isUrlSupported:(e[5]&2)!==0,isTlmSupported:(e[5]&4)!==0,isEidSupported:(e[5]&8)!==0,supportedTxPowerLevels:r}},Ke=function(t){let e=function(o){let c=parseInt(o.substring(2,4),16),u=o.substring(4,24),l=o.substring(24,36);return{frameType:"UID",txPower:c,namespace:u,instance:l}},r=function(o){let c=parseInt(o.substring(2,4),16),u=o.substring(4,6),l="";switch(u){case"00":l="http://www.";break;case"01":l="https://www.";break;case"02":l="http://";break;case"03":l="https://";break;default:throw new Error("Eddystone URL scheme is not valid.")}let d=[".com/",".org/",".edu/",".net/",".info/",".biz/",".gov/",".com",".org",".edu",".net",".info",".biz",".gov"],f=o.substring(6,o.length),w=l;for(let R=0;R<f.length;R+=2){let P=parseInt(f.substring(R,R+2),16);P<d.length?w+=d[P]:w+=String.fromCharCode(P)}return{frameType:"URL",txPower:c,url:w}},n=function(o){let c=parseInt(o.substring(4,8),16),u=parseInt(o.substring(8,10),16)+parseInt(o.substring(10,12),16)/100,l=parseInt(o.substring(12,20),16),d=parseInt(o.substring(20,28),16);return{frameType:"TLM",batteryVoltage:c,beaconTemperature:u,pduCount:l,timeSinceReboot:d}},i=[];for(let o=0;o<t.length;o+=2)i.push(parseInt(t.substring(o,o+2),16));let a=new Uint8Array(i).reduce((o,c)=>o+("0"+c.toString(16)).slice(-2),""),s;switch(a[0]+a[1]){case"00":return s=e(a),s.namespace+s.instance;case"10":return s=r(a),s.url;case"20":return s=n(a),s.beaconTemperature;case"30":throw new Error("EID frame type is not supported by blast.");default:throw new Error("Eddystone frame type is not valid.")}},Ye=function(t,e){let r=function(i){let a=["http://www.","https://www.","http://","https://"],s=[".com/",".org/",".edu/",".net/",".info/",".biz/",".gov/",".com",".org",".edu",".net",".info",".biz",".gov"],o=[],c=0,u=new TextEncoder;for(let l=0;l<a.length;l++)if(i.startsWith(a[l])){o.push(l),c=a[l].length;break}for(;c<i.length;){let l=c;for(let d=0;d<s.length;d++)if(i.startsWith(s[d],c)){o.push(d),c+=s[d].length;break}l===c&&(o.push(u.encode(i[c])[0]),c++)}if(o.length>18)throw new Error("URL is too long.");return o.splice(0,0,16),new Uint8Array(o)},n;switch(e){case"URL":break;case"UID":break;case"TLM":throw new Error("TLM frame type is not writable.");case"EID":throw new Error("EID frame type is not writable.");default:throw new Error('Unkown frame type. Known types are "UID", "URL", "TLM", or "EID".')}if(e==="URL")n=r(t);else{if(!/^[0-9A-Fa-f]{32}$/.test(t))throw new Error("Eddystone UID must be 32 hexadecimal characters.");n="00"+t}return n},Qe={EDDYSTONE_CONFIG_SERVICE:Ge,EDDYSTONE_CHARACTERISTICS:_e,parseCapabilities:Je,decodeAdvertisingData:Ke,encodeAdvertisingData:Ye},v=require("stream"),Xe=require("web-streams-polyfill"),Ze=class{servient;wot;constructor(t,e){let r={port:8083,allowSelfSigned:!0};if(this.servient=new m.Servient,t){let n=new t;n&&(this.servient.addClientFactory(new He(n)),this.servient.addClientFactory(new Me(n)))}if(e){let n=new e;n&&this.servient.addClientFactory(new Ne(n))}this.servient.addClientFactory(new F.HttpClientFactory(r)),this.servient.addClientFactory(new F.HttpsClientFactory(r))}async getWot(){return this.wot||(this.wot=await this.servient.start()),this.wot}async resetServient(){if(this.servient){let t=this.servient.getThings();Object.entries(t).forEach(async([e])=>{let r=this.servient.getThing(e);r&&await r.destroy()});try{await this.servient.shutdown()}catch{}}}async createExposedThing(t,e){if(e){let r={MacOrWebBluetoothId:e,HIDPATH:e};t=structuredClone(t),t=et(t,r)}return await(await this.getWot()).produce(t)}async createThing(t,e){let r=await this.createExposedThing(t,e);return await(await this.getWot()).consume(r.getThingDescription())}async createThingWithHandlers(t,e,r){let n=await this.createExposedThing(t,e);return r(n),tt(n)}},et=function(t,e={}){let r=new Ae.JsonPlaceholderReplacer;return r.addVariableMap(e),r.replace(t)},tt=function(t){let e={};return e.id=t.getThingDescription().id,e.name=t.getThingDescription().title,e.getThingDescription=t.getThingDescription,e.subscribeEvent=async function(r,n,i,a){let s=t.events[r];if(s){let o={op:"subscribeEvent",contentType:"application/octet-stream;length=1;"};s.forms=[o];let c=u=>{let l=new L.InteractionOutput(u);l.form=o,n(l)};return t.__eventListeners.register(s,0,c),{active:!0,stop:async u=>{t.__eventListeners.unregister(s,0,c)}}}else throw new Error(`Event '${r}' not found`)},e.invokeAction=async function(r,n,i={}){let a={op:"invokeAction"};t.actions[r].forms=[a];let s=new v.Readable;n&&(s=J(n));let o=t.actions[r].input?.type;if(!o)throw new Error(`Action '${r}' has no input type`);switch(o){case"string":case"boolean":case"number":o="text/plain";break;default:o="application/json"}let c=new m.Content(o,s),u=await t.handleInvokeAction(r,c,{formIndex:0,...i});return u===void 0&&(u=new m.Content(o,new v.Readable)),new L.InteractionOutput(u)},e.readProperty=async function(r,n={}){let i=t.properties[r];if(!i)throw new Error(`Property '${r}' not found`);let a={op:"readProperty"};i.forms=[a];let s=await t.handleReadProperty(r,{formIndex:0,...n});return new L.InteractionOutput(s,a)},e.writeProperty=async function(r,n,i={}){let a=t.properties[r];if(!a)throw new Error(`Property '${r}' not found`);let s={op:"writeProperty"};a.forms=[s];let o=new v.Readable;n&&(o=J(n));let c=t.properties[r].type;if(!c)throw new Error(`Property '${r}' has no type`);switch(c){case"string":case"boolean":case"number":c="text/plain";break;default:c="application/json"}let u=new m.Content(c,o);await t.handleWriteProperty(r,u,{formIndex:0,...i})},e},J=function(t){let e;return typeof ReadableStream<"u"&&t instanceof ReadableStream||t instanceof Xe.ReadableStream?e=m.ProtocolHelpers.toNodeStream(t):Array.isArray(t)||typeof t=="object"?e=v.Readable.from(Buffer.from(JSON.stringify(t),"utf-8")):e=v.Readable.from(Buffer.from(t.toString(),"utf-8")),e}});var dt={};ge(dt,{HidHelpers:()=>ue,createExposedThing:()=>ct,createThing:()=>ut,createThingWithHandlers:()=>lt,getWot:()=>st,resetServient:()=>ot});module.exports=me(dt);var le=g(B());var re=g(B(),1),ne=require("ble-host"),ie=g(require("hci-socket"),1),ae=require("@node-wot/core"),{debug:p}=(0,ae.createLoggers)("binding-bluetooth","NodeBluetoothAdapter"),rt=new ie.default,nt={},O=class extends Event{target;constructor(e,r){super(e),this.target=r}},y=class extends re.BluetoothAdapter{bleManager=void 0;connectedDevices=new Map;async getBleManager(){return this.bleManager===void 0&&(this.bleManager=await new Promise((e,r)=>{ne.BleManager.create(rt,nt,(n,i)=>{n?r(n):e(i)})})),this.bleManager}async getCharacteristic(e,r,n){p(`getCharacteristic ${e} ${r} ${n}`);let i=await this.getBleManager();e.length===12&&(e=e.match(/.{1,2}/g).join(":").toUpperCase()),r=r.toUpperCase(),n=n.toUpperCase(),p(`Connecting to ${e}`);let a=this.connectedDevices.get(e)??await new Promise((c,u)=>{setTimeout(()=>{u(new Error("Connection timeout"))},4e3),i.connect("public",e,{},l=>{this.connectedDevices.set(e,l),l.on("disconnect",()=>{this.connectedDevices.delete(e)}),c(l)}),i.connect("random",e,{},l=>{this.connectedDevices.set(e,l),l.on("disconnect",()=>{this.connectedDevices.delete(e)}),c(l)})});p(`Connected to ${e}`);let s=await new Promise((c,u)=>{a.gatt.discoverAllPrimaryServices(l=>{let d=l.find(f=>f.uuid===r);d===void 0?u(new Error(`Service ${r} not found on device ${e}`)):c(d)})}),o=await new Promise((c,u)=>{s.discoverCharacteristics(l=>{let d=l.find(f=>f.uuid===n);d?(p(`Found characteristic ${n}`),c(d)):u(new Error(`Characteristic ${n} not found on service ${r}`))})});return this.wrap(o)}async observeGAP(e,r){let i=(await this.getBleManager()).startScan({});e.length===12&&(e=e.match(/.{1,2}/g).join(":").toUpperCase()),i.on("report",a=>{if(a.address===e){let s={target:{address:a.address,rssi:a.rssi,txPower:a.parsedDataItems.txPowerLevel,manufacturerData:a.parsedDataItems.manufacturerSpecificData,serviceData:a.parsedDataItems.serviceData,serviceUuids:a.parsedDataItems.serviceUuids}};r(s)}})}wrap(e){let r={service:{},uuid:e.uuid,properties:e.properties,value:void 0,readValue:()=>new Promise((n,i)=>{p("readValue"),e.read((a,s)=>{if(a||s===void 0)i(a);else{p("readValue done",s);let o=new Uint8Array(s).buffer;n(new DataView(o))}})}),writeValue:async n=>new Promise((i,a)=>{p("writeValue",n),e.write(Buffer.from(n),s=>{s?a(s):i()})}),writeValueWithoutResponse:async n=>new Promise((i,a)=>{p("writeValueWithoutResponse",n),e.writeWithoutResponse(Buffer.from(n),void 0,s=>{s?a(s):i()})}),writeValueWithResponse:async n=>new Promise((i,a)=>{p("writeValueWithResponse",n),e.write(Buffer.from(n),s=>{s?a(s):(p("writeValueWithResponse done"),i())})}),startNotifications:()=>new Promise((n,i)=>{e.writeCCCD(!0,!1,a=>{a?i(a):n(r)})}),stopNotifications:()=>new Promise((n,i)=>{e.writeCCCD(!1,!1,a=>{a?i(a):n(r)})}),addEventListener:(n,i,a)=>{e.on("change",(s,o,c)=>{if(i){p("characteristicvaluechanged event received with value ",s);let u=new Uint8Array(s).buffer;r.value=new DataView(u),p("calling listener with value ",r.value),i(new O("characteristicvaluechanged",r))}})},removeEventListener:(n,i,a)=>{e.removeEventListener("change",i)}};return r}};var se=g(B(),1),E=require("node-hid"),oe=require("@node-wot/core"),{debug:it}=(0,oe.createLoggers)("binding-hid","WebHidAdapter"),S=class t extends se.HidAdapter{devices=new Map;async getDevice(e){if(it(`Getting device at path ${e}`),this.devices.has(e))return this.devices.get(e);let n=(0,E.devices)().find(a=>a.path===e);if(!n)throw new Error(`Device with id ${e} not found`);let i=t.wrap(n,new E.HID(n.path));return this.devices.set(e,i),i}static wrap(e,r){let n={open:async()=>{new E.HID(e.path)},close:async()=>{r.close()},forget:async()=>{r.close()},sendReport:async(i,a)=>{let s=Buffer.concat([Buffer.from([i]),Buffer.from(a)]);r.write(s)},sendFeatureReport:async(i,a)=>{r.sendFeatureReport(a)},receiveFeatureReport:async i=>new DataView(new ArrayBuffer(0)),opened:!0,vendorId:e.vendorId,productId:e.productId,productName:e.product??"",collections:[],oninputreport:null,addEventListener:(i,a,s)=>{},removeEventListener:(i,a)=>{},dispatchEvent:i=>!0};return n.addEventListener=(i,a)=>{i==="inputreport"&&r.on("data",s=>{let o={type:"inputreport",device:n,reportId:s[0],data:new DataView(s.buffer,1),bubbles:!1,cancelBubble:!1,cancelable:!1,composed:!1,currentTarget:null,defaultPrevented:!1,eventPhase:0,isTrusted:!1,returnValue:!1,srcElement:null,target:null,timeStamp:0,composedPath:function(){throw new Error("Function not implemented.")},initEvent:function(c,u,l){throw new Error("Function not implemented.")},preventDefault:function(){throw new Error("Function not implemented.")},stopImmediatePropagation:function(){throw new Error("Function not implemented.")},stopPropagation:function(){throw new Error("Function not implemented.")},AT_TARGET:2,BUBBLING_PHASE:3,CAPTURING_PHASE:1,NONE:0};a(o)})},n}};var U=g(require("node-hid")),ce=g(require("inquirer")),D=class{device=null;async showSelector(){U.default.setDriverType("libusb");let i=[{type:"list",name:"device",message:"Select a device",choices:U.default.devices().filter(s=>s.manufacturer&&s.product).map(s=>({name:`${s.manufacturer} ${s.product}`,value:s}))}],a=await ce.default.prompt(i);this.device=a.device}};async function at(){let t=new D;return await t.showSelector(),t.device}var ue={selectDevice:at};var I=new le.default(y,S),st=async()=>I.getWot(),ot=async()=>I.resetServient(),ct=async(t,e)=>I.createExposedThing(t,e),ut=async(t,e)=>I.createThing(t,e),lt=async(t,e,r)=>I.createThingWithHandlers(t,e,r);0&&(module.exports={HidHelpers,createExposedThing,createThing,createThingWithHandlers,getWot,resetServient});
