<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en" xml:lang="en">

<head>
  <meta content="text/html;" charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BLAST - Block applications for things</title>
  <link rel="stylesheet" href="style.css">
  <link rel="apple-touch-icon" sizes="57x57" href="media/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="media/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="media/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="media/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="media/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="media/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="media/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="media/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="media/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="media/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="media/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="media/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="media/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="site.webmanifest">

  <!-- JS Interpreter -->
  <script src="js/lib/JSInterpreter/acorn.js"></script>
  <script src="js/lib/JSInterpreter/interpreter.js"></script>

  <!-- blockly with js generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/blockly_compressed.min.js"
    integrity="sha512-iqNC/BA2OwsMa0EMB4Xnxm7i+Y38C5j26CjgG/prCg74ILAJomPIIyp+I45hVfV9A50vnaGoh808fu6GaGAuHw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/msg/en.min.js"
    integrity="sha512-CcZSuOhlsHqLLiF3M8hvMc8aWqTE36GEaE/cP7HMNOSZytGihNqhQxFzkXigYQp4psZWCVjEXY2oYFN4+vLAYg=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/blocks_compressed.min.js"
    integrity="sha512-2EDgchO+DLca8kTvZv5NGY57nB+fH3DelW4qIKEW94cUy+UpgHNdpO6GCSxUtGYuG6ny7f2fssqCIrlN3WrHvw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/javascript_compressed.min.js"
    integrity="sha512-ATkMUjg1QwPS8AgpyN53xYVsIlqlYa8N3jxp0XYLRxdCXxzh1LmC+WmpilE/E9sFX1RVdxidf2bFI9O8Pl5bUw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>

  <!-- urdf -->
  <script src="js/lib/urdf/urdf-browser.js"></script>

  <!-- play/stop icons -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/svgxuse/1.2.6/svgxuse.min.js"
    integrity="sha512-yipBrwYdC4+gC3Rm6FY8KG+2xNTU+frQScGdqXFWanTQn9ZBRBNJ3R3vQ+7gkAxu2ilb5SuFer0DL+dNTTtyhg=="
    crossorigin="anonymous"></script>

  <!-- blast libraries -->
  <script src="js/blast.min.js"></script>

</head>

<body>
  <table width="100%" height="100%">
    <tr>
      <td>
        <table width="100%">
          <tr id="tabRow" height="1em">
            <td id="tab_workspace" class="tabon">Workspace</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_javascript" class="taboff">JavaScript</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_xml" class="taboff">XML</td>
            <td class="tabmin">&nbsp;</td>
            <td id="inputs_td" class="tabmin">
              <input list="samples" type="text" id="loadWorkspace-input"
                placeholder="samples/gamble.xml">
              <datalist id="samples">
                <option value="samples/gamble.xml"></option>
                <option value="samples/hello-world"></option>
                <option value="samples/playAudio.xml"></option>
                <option value="samples/sounds.xml"></option>
                <option value="samples/states.xml"></option>
                <option value="samples/streamdeck.xml"></option>
                <option value="samples/webSpeech.xml"></option>
              </datalist>
            </td>
            <td class="tabmin">
              <button id="loadButton" title="load workspace">
                <svg class="icon icon-download">
                  <use xlink:href="media/symbol-defs.svg#icon-download"></use>
                </svg>
              </button>
            </td>
            <td class="tabmin">
              <button id="saveButton" title="save workspace">
                <svg class="icon icon-upload">
                  <use xlink:href="media/symbol-defs.svg#icon-upload"></use>
                </svg>
              </button>
            </td>
            <td class="tabmax">
              <span id="statusContainer">ready</span>
              <button id="runButton" class="primary" title="Run the program">
                <svg class="icon icon-play">
                  <use xlink:href="media/symbol-defs.svg#icon-play"></use>
                </svg>
              </button>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td id="content_area">
      </td>
      <td id="output_area">
        <div id="msgOutputContainer">
        </div>
      </td>
    </tr>
  </table>

  <!-- WebBluetooth Modal -->
  <div id="wbModal" class="modal">
    <div class="modal-content">
      <span id ="wbClose" class="close">&times;</span>
      <h1>Connect a thing via WebBluetooth</h1>
      <hr>     
      <div class="row" id="web-bluetooth-connect-row">
        <div class="col">
          <form>
            <h1>Filter for specific devices:</h1>
            <label for="wb-allDevices">All Devices</label><input id="wb-allDevices" type="checkbox" checked>
            <input id="wb-name" type="text" size="17" placeholder="Device Name">
            <br><br>
            <input id="wb-namePrefix" type="text" size="17" placeholder="Device Name Prefix">
            <br><br>
            <input type="button" id="wb-connect" value="pair">
          </form>
          <div>
            <h3>Error output:</h3>
            <div id="wb-output" class="wb-output">
              <pre id="wb-log"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- WebHID Modal -->
  <div id="wHidModal" class="modal">
    <div class="modal-content">
      <span id ="wHidClose" class="close">&times;</span>
      <h1>Connect a thing via WebHID</h1>
      <hr>     
      <div class="row" id="web-hid-connect-row">
        <div class="col">
          <form>
            <h1>Filter for specific devices: (or leave empty)</h1>
            <label for="wHid-knownDevices">List of known devices</label>
            <select id="wHid-knownDevices">
              <option value=""></option>
              <option value='{ "filters": [{"vendorId": "0x0fd9", "productId": 99}] }'>elGato StreamDeck Mini</option>
            </select>
            <br><br>
            <input id="wHid-vendorId" type="text" size="17" placeholder="Vendor ID">
            <br><br>
            <input id="wHid-productId" type="text" size="17" placeholder="Product ID">
            <br><br>
            <input type="button" id="wHid-connect" value="connect">
          </form>
          <div>
            <h3>Error output:</h3>
            <div id="wHid-output" class="wHid-output">
              <pre id="wHid-log"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="content_workspace" class="content"></div>
  <pre id="content_javascript" class="content prettyprint lang-js"></pre>
  <textarea id="content_xml" class="content" wrap="off"></textarea>
</body>
<script>
  // Add service worker to the page
  window.addEventListener('load', function() {
    if (navigator.serviceWorker) {
      navigator.serviceWorker.register('sw.js', { scope: './' });
    }
  });

  /**
   * WebBluetooth and WebHID modal methods
   */
  const wbModal = document.getElementById("wbModal");
  const wbClose = document.getElementById("wbClose");
  const wHidModal = document.getElementById("wHidModal");
  const wHidClose = document.getElementById("wHidClose");

  // logs webBluetooth to wb-output div
  const wbLog = function(){
    var line = Array.prototype.slice.call(arguments).map(function(argument) {
      return typeof argument === 'string' ? argument : JSON.stringify(argument);
    }).join(' ');

    document.getElementById('wb-log').textContent += line + '\n';
  }
  
  // logs webBluetooth to wb-output div
  const wHidLog = function(){
    var line = Array.prototype.slice.call(arguments).map(function(argument) {
      return typeof argument === 'string' ? argument : JSON.stringify(argument);
    }).join(' ');

    document.getElementById('wHid-log').textContent += line + '\n';
  }

  // request bt devices when pair button is clicked
  const wbPairButton = document.getElementById('wb-connect');
  wbPairButton.addEventListener('click', function() {
    let filters = [];

    let filterName = document.getElementById('wb-name').value;
    if (filterName) {
      filters.push({name: filterName});
    }

    let filterNamePrefix = document.getElementById('wb-namePrefix').value;
    if (filterNamePrefix) {
      filters.push({namePrefix: filterNamePrefix});
    }

    let options = {};

    if (document.getElementById('wb-allDevices').checked) {
      options.acceptAllDevices = true;
    } else {
      options.filters = filters;
    }

    options.optionalServices = ['0000fff0-0000-1000-8000-00805f9b34fb'];

    navigator.bluetooth.requestDevice(options)
      .then(device => {
        // wbLog('> Name:             ' + device.name);
        // wbLog('> Id:               ' + device.id);
        // wbLog('> Connected:        ' + device.gatt.connected);
        wbModal.style.display = "none";
        Blast.Things.addWebBluetoothDevice(device.id, device.name);
        Blast.workspace.refreshToolboxSelection();
      })
      .catch(error => {
        wbLog('Argh! ' + error);
      });
  });

  
  // request HID devices when pair button is clicked
  const hidPairButton = document.getElementById('wHid-connect');
  hidPairButton.addEventListener('click', function() {
    let filters = [];

    let filterVendor = document.getElementById('wHid-vendorId').value;
    if (filterVendor) {
      filters.push({vendorId: filterVendor});
    }

    let filterProductId = document.getElementById('wHid-productId').value;
    if (filterProductId) {
      filters.push({vendorId: filterVendor, productId: filterProductId});
    }

    navigator.hid.requestDevice({filters})
      .then(device => {
        if (device.length === 0) throw new Error('Connection failed or cancelled by User.');
        wHidModal.style.display = "none";
        // generate a unique id for the new device
        const uid = Date.now().toString(36) + Math.random().toString(36).substr(2);
        // add device to the device map with its uid
        Blast.Things.webHidDevices.set(uid, device[0]);
        Blast.Things.addWebHidDevice(uid, '');
        Blast.workspace.refreshToolboxSelection();
      })
      .catch(error => {
        wHidLog('Argh! ' + error);
      });
  });

  // Make sure web bluetooth filters are correct
  const wballDevices = document.getElementById('wb-allDevices');
  const wbName = document.getElementById('wb-name');
  const wbnamePrefix = document.getElementById('wb-namePrefix');
  const updateFiltersCb = function() {
    const name = wbName.value;
    const namePrefix = wbnamePrefix.value;
    const allDevice = wballDevices.checked;

    if(name != '' || namePrefix != ''){
      wballDevices.checked = false;
    }
  }
  wbnamePrefix.addEventListener('change', updateFiltersCb);
  wbName.addEventListener('keyup', updateFiltersCb);
  wballDevices.addEventListener('change', function() {
    if(wballDevices.checked){
      wbName.value = '';
      wbnamePrefix.value = '';
    }
  })

  // Fill webHid filter inputs when known devices dropdown changes
  const wHidKnownDevices = document.getElementById('wHid-knownDevices');
  const wHidVendorIdFilter = document.getElementById('wHid-vendorId');
  const wHidProductIdFilter = document.getElementById('wHid-productId');
  const updateHidFilter = function() {
    const jsonValue = JSON.parse(wHidKnownDevices.value);
    wHidVendorIdFilter.value = jsonValue.filters[0].vendorId;
    wHidProductIdFilter.value = jsonValue.filters[0].productId;
  }

  wHidKnownDevices.addEventListener('change', updateHidFilter);

  wbClose.onclick = function () {
    wbModal.style.display = "none";
  }
  
  wHidClose.onclick = function () {
    wHidModal.style.display = "none";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function (event) {
    if (event.target == wbModal) {
      wbModal.style.display = "none";
    }
    if (event.target == wHidModal) {
      wHidModal.style.display = "none";
    }
  }
</script>

</html>
