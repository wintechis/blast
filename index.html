<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>BLAST Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/solid-auth-client@2.4.1/dist-lib/solid-auth-client.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/solid-file-client"></script>
  <script src="js/solid.js" type="application/javascript"></script>
  <script src="js/blockly_compressed.js"></script>
  <script src="js/javascript_compressed.js"></script>
  <script src="js/blocks_compressed.js"></script>
  <script src="js/query_blocks.js"></script>
  <script src="js/query_stubs.js"></script>
  <script src="js/urdf-browser.js"></script>
  <script src="js/blockly_things.js"></script>
  <script src="msg/js/en.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      background-color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }

    h1 {
      font-weight: normal;
      font-size: 140%;
    }

    #page-body {
      height: 100%;
      width: 100%;
    }

    #blocklyArea {
      height: 99%;
    }

    #resultsArea {
      height: 99%;
      width: 450px;
      border: 1px solid #c6c6c6;
      vertical-align: top;
    }

    .status {
      float: right;
    }

    .controlButtons {
      height: 30px;
      margin-right: 15px;
    }

    .message {
      border: 2px solid #dedede;
      background-color: #f1f1f1;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 10px;
    }

    .time {
      float: right;
      color: #aaa;
    }

    #messageBox {
      width: 450px;
      height: 100%;
      overflow: auto;
    }

    #messageBox table,
    #messageBox th,
    #messageBox td {
      margin: 10px auto;
      padding: 5px;
      border-collapse: collapse;
      border: 1px solid black;
    }


    /* The Modal (background) */
    .modal {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /* Sit on top */
      padding-top: 100px;
      /* Location of the box */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.4);
      /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    .modal-content a {
      display:block;
      width: 200px;
      height: 50px;
    }


    /* Modal Close Button */
    .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <table id="page-body">
    <tr>
      <td>
        <h1>BLAST - Block Applications for Things</h1>
        <p>
          The menu on the left contains different blocks.</br>
          Move them into either the setup- or loop-block below to define a blockprogram.</br>
          When finished click the execute button on the bottom-right to start the program.<br>
          For more information on each of the blocks, check the <a href="docs/Blocks.md" target="_blank"
            rel="noopener noreferrer">documentation</a>.
        </p>
        <button><a onclick="Blockly.Things.saveButtonHandler()">Save Workspace</a></button>
        <button onclick="Blockly.Things.loadButtonHandler()">load Workspace</button>
        <button onclick="loadSampleButtonHandler()">load sample</button>
      </td>
    </tr>
    <tr>
      <td id="blocklyArea">
      </td>
      <td id="resultsArea">
        <div id="messageBox"></div>
      </td>
    </tr>
    <tr>
      <td>
        <div class="status">
          <span id="status"></span>
          <button onclick="stopCode('stopped')" id="stop" class="controlButtons" disabled>stop</button>
          <button onclick="runCode()" id="run" class="controlButtons">execute</button>
        </div>
      </td>
    </tr>
  </table>

  <div id="blocklyDiv" style="position: absolute"></div>

  <div id="sampleModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <a onClick="loadSample('gamble')">Gamble</a><br>
      <a onClick="loadSample('sparql')">SPARQL</a>
    </div>
  </div>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="Things" custom="things_category" colour="270"></category>
    <category name="Variables" custom="VARIABLE" colour="330">

    </category>
    <category name="Actions" colour="0">
      <block type="message"></block>
      <block type="display"></block>
      <block type="sparql_query"></block>
      <block type="switchlights"></block>
      <block type="randomsound"></block>
      <block type="halt"></block>
    </category>
    <category name="Logic" colour="210">
      <block type="controls_if"></block>
      <block type="event"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
    </category>
    <category name="Booleans" colour="210">
      <block type="logic_boolean"></block>
    </category>
    <category name="Text" colour="160">
      <block type="text"></block>
      <block type="text_join"></block>
    </category>
    <category name="Numbers" colour="230">
      <block type="math_number"></block>
      <block type="infinity"></block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
    </category>
    <!-- <category name="Variables" colour="330" custom="VARIABLE"></category>
    <category name="Functions" colour="290" custom="PROCEDURE"></category> -->
  </xml>
  <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
    <block type="setup" id="setup" movable="false" deletable="false" inline="false" x="10" y="10"></block>
    <block type="loop" id="loop" deletable="false " x="10" y="250">
      <value name="n">
        <block type="infinity"></block>
      </value>
      <value name="seconds">
        <block type="math_number">
          <field name="NUM">2</field>
        </block>
      </value>
    </block>
  </xml>

  <script>

    var messageCounter = 0;

    function displayText(text) {
      msg = document.createElement("div");
      msg.classList.add("message");
      msg.id = "message-" + messageCounter;

      textNode = document.createTextNode(text);
      msg.appendChild(textNode);

      timeSpan = document.createElement("span");
      timeSpan.classList.add("time");
      timeSpan.innerHTML = new Date().toLocaleTimeString();
      msg.appendChild(timeSpan);

      msgBox = document.getElementById("messageBox");
      msgBox.insertBefore(msg, msgBox.firstChild);
    }

    displayText("Actionblock output will be displayed here");


    /*  
    ################
    # BLOCKLY CODE # 
    ################
    */

    var blocklyArea = document.getElementById('blocklyArea');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var workspace = Blockly.inject(blocklyDiv, { toolbox: document.getElementById('toolbox') });

    var onresize = function (e) {
      // Compute the absolute coordinates and dimensions of blocklyArea.
      var element = blocklyArea;
      var x = 0;
      var y = 0;
      do {
        x += element.offsetLeft;
        y += element.offsetTop;
        element = element.offsetParent;
      } while (element);
      // Position blocklyDiv over blocklyArea.
      blocklyDiv.style.left = x + 'px';
      blocklyDiv.style.top = y + 'px';
      blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
      blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
      Blockly.svgResize(workspace);
    };
    window.addEventListener('resize', onresize, false);
    onresize();
    Blockly.svgResize(workspace);

    var interval = null;

    runCode = function () {
      // disable run button and enable stop button
      document.getElementById("stop").disabled = false;
      document.getElementById("run").disabled = true;
      document.getElementById("status").innerHTML = "running... ";

      // stop loop interval
      var prevInterval = interval;
      clearInterval(prevInterval);

      // clear process arrays
      var setup = [];
      var loop = []

      // query data first
      var addresses = getAllAddresses();
      queryAlliBeacons(addresses).then(() => {
        var code = Blockly.JavaScript.workspaceToCode(workspace);

        console.log(code);

        // pushes the block's code into either setup or loop array 
        eval(code);

        // eval setup
        for (process of setup) {
          eval(process);
        }

        prevResultsMap = new Map(resultsMap);

        //eval loop
        var setupBlock = workspace.getBlockById("setup");
        var addresses = getiBeaconAddressesInBlock(setupBlock);

        // stop condition
        if (!eval(loopCondition)) {
          stopCode('finished');
          return;
        }

        // first iteration
        for (process of loop) {
          eval(process);
        }

        // repeat after n seconds
        interval = setInterval(function () {

          var addresses = getAllAddresses();
          queryAlliBeacons(addresses).then(() => {
            if (!eval(loopCondition)) {
              stopCode('finished');
              return;
            }

            for (process of loop) {
              eval(process);
            }
          });

          prevResultsMap = new Map(resultsMap);
        }, loopTime * 1000)
      })
    }

    getAllAddresses = function () {
      let receivers = workspace.getBlocksByType("receiver_get");
      var addresses = []
      receivers.forEach(block => {
        if (block.type != 'receiver_get') return;
        var thingName = block.getFieldValue('thing');
        var thing = Blockly.Things.thingsMap.receiver[thingName];
        addresses.push(thing.address);
      })
      addresses = eliminateDupilactes(addresses);
      return addresses;
    }

    getiBeaconAddressesInBlock = function (parentBlock) {
      // array of addresses to be queried (will elimanate duplicates later)
      var addresses = [];
      parentBlock.getDescendants()
        .forEach(block => {
          if (block.type != 'receiver_get') return;
          var thingName = block.getFieldValue('thing');
          var thing = Blockly.Things.thingsMap.receiver.thingName;
          addresses.push(thing.address);
        })
      addresses = eliminateDupilactes(addresses);
      return addresses;
    }

    eliminateDupilactes = function (array) {
      return [...new Set(array)];
    }

    stopCode = function (message) {
      // enable run button and disable stop button
      document.getElementById("stop").disabled = true;
      document.getElementById("run").disabled = false;

      // stop interval execution and set status text
      clearInterval(interval)
      document.getElementById("status").innerHTML = message;
    }

    // Setting blocks on startup
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), Blockly.mainWorkspace);

    // creates blocks in things category
    workspace.registerToolboxCategoryCallback("things_category", Blockly.Things.flyoutCallback);

    /*
    #############
    # uRDF Code #
    #############
    */

    function displayData(key) {

      let resultsField = document.createElement("table");

      // deal with missing values
      results = resultsMap.get(key);
      let vars = ["mac", "rssi", "resultTime"];

      let html = '<tr>';
      vars.forEach(v => html += '<th>' + v + '</th>');
      html += '</tr>';

      results.forEach(res => {
        html += '<tr>';
        vars.forEach(v => {
          html += '<td>' + (res[v] ? res[v].value : '') + '</td>'
        });
        html += '</tr>';
      });

      resultsField.innerHTML = html;

      var div = document.getElementById("messageBox");
      div.insertBefore(resultsField, div.firstChild);
    }

    function switchLights(mac, r, y, g) {
      var r_byte = r ? "ff" : "00";
      var y_byte = y ? "ff" : "00";
      var g_byte = g ? "ff" : "00";

      var data = { type: "Write", data: { "@value": "7e000503" + r_byte + g_byte + y_byte + "00ef", "@type": "ble:HexString" } };

      fetch(`http://192.168.178.22:8000/devices/${mac}/char/0009/`, {
        method: "POST",
        headers: new Headers({
          "Content-Type": "application/json"
        }),
        body: JSON.stringify(data)
      }).then(res => {
        console.log("Request complete! response:", res);
      })
    }

    var resultsMap = new Map();

    function queryAlliBeacons(addresses) {
      return new Promise((resolve, reject) => {
        if (addresses.length == 0) {
          resolve();
        }
        return Promise.all(addresses.map(address => {
          var url = new URL(address);
          var baseUrl = url.protocol + "//" + url.host;
          var path = url.pathname;

          var query =
            `BASE <${baseUrl}>
            PREFIX rdf: <http://w3.org/1999/02/22-rdf-syntax-ns#>
            PREFIX sosa: <http://www.w3.org/ns/sosa/>
            PREFIX ble: <http://vocab.rapidthings.eu/ns/ble.ttl#>
            PREFIX a: <http://vocab.rapidthings.eu/ns/ble/adapter.ttl#>

            
            SELECT ?mac ?rssi ?resultTime
            FROM <${path}>
            WHERE 
            {
                ?history ble:entries ?obs .
                ?obs a ble:RssiObservation .
                ?obs sosa:madeBySensor ?mac .
                ?obs sosa:hasSimpleResult ?rssi .
                ?obs sosa:resultTime ?resultTime .
            }`;

          urdf.clear();
          urdf.query(query)
            .then(result => {
              let formattedResult = new Map();
              for (r of result) {
                formattedResult.set(r.mac.value, r);
              }
              resultsMap.set(address, formattedResult);
              resolve();
            })
        }));
      });
    }

    function loadSampleButtonHandler() {
      var modal = document.getElementById("sampleModal");
      modal.style.display = "block";

      var span = document.getElementsByClassName("close")[0];

      // When the user clicks on <span> (x), close the modal
      span.onclick = function () {
        modal.style.display = "none";
      }

      // When the user clicks anywhere outside of the modal, close it
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
    }

    function loadSample(sample) {
      var url = `sample-workspaces/${sample}.json`;
      getJSON(url, function (status, data) {
        restore(data);

        var modal = document.getElementById("sampleModal");
        modal.style.display = "none";
      });
    }

    function getJSON(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'text';
      xhr.onload = function () {
        var status = xhr.status;
        if (status === 200) {
          callback(null, xhr.response);
        } else {
          callback(status, xhr.response);
        }
      };
      xhr.send();
    };

    function sparqlQuery(query) {

      urdf.clear();
      urdf.query(query)
        .then(results => {
          if(results.length == 0){
            displayText("the SPARQL query returned no results.")
          }

          // deal with missing values
          let vars = results.reduce((list, res) => {
            for (let v in res) {
              if (list.indexOf(v) === -1) list.push(v);
            }
            return list;
          }, []);

          let html = '<tr>';
          vars.forEach(v => html += '<th>' + v + '</th>');
          html += '</tr>';

          results.forEach(res => {
            html += '<tr>';
            vars.forEach(v => html += '<td>' + (res[v] ? res[v].value : '') + '</td>');
            html += '</tr>';
          });

          let resultsField = document.createElement("table");
          resultsField.innerHTML = html;
          var msgBox = document.getElementById("messageBox");
          msgBox.insertBefore(resultsField, msgBox.firstChild);
        })
        .catch(e => {
          displayText("the SPARQL query returned an error, see console for details.")
          console.error(e);
        });
    }
  </script>
  <script src="js/sounds.js"></script>
</body>

</html>