<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>BLAST Demo</title>
  <script
    src="https://cdn.jsdelivr.net/npm/solid-auth-client@2.3.0/dist-lib/solid-auth-client.bundle.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/solid-file-client@1.0.0/dist/window/solid-file-client.bundle.js"></script>
  <script src="js/solid.js" type="application/javascript"></script>
  <script src="js/blockly_compressed.js"></script>
  <script src="js/javascript_compressed.js"></script>
  <script src="js/acorn_interpreter.js"></script>
  <script src="js/blocks_compressed.js"></script>
  <script src="js/query_blocks.js"></script>
  <script src="js/query_stubs.js"></script>
  <script src="js/urdf-browser.js"></script>
  <script src="msg/js/en.js"></script>
  <script src="js/interpreter-api.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      background-color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }

    h1 {
      font-weight: normal;
      font-size: 140%;
    }

    #page-body {
      width: 100%;
    }

    #blocklyArea {
      height: 99%;
    }

    #resultsArea {
      height: calc(100vh - 215px);
      width: 450px;
      border: 1px solid #c6c6c6;
      vertical-align: top;
    }

    .status {
      float: right;
    }

    .controlButtons {
      height: 30px;
      margin-right: 15px;
    }

    .message {
      border: 2px solid #dedede;
      background-color: #f1f1f1;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 10px;
    }

    .time {
      float: right;
      color: #aaa;
    }

    #messageBox {
      width: 450px;
      height: 100%;
      overflow: auto;
    }

    #messageBox table,
    #messageBox th,
    #messageBox td {
      margin: 10px auto;
      padding: 5px;
      border-collapse: collapse;
      border: 1px solid black;
    }

    #loadWorkspace-input {
      width: 400px;
    }
  </style>
</head>

<body>
  <table id="page-body">
    <tr>
      <td>
        <h1>BLAST - Block Applications for Things</h1>
        <p>
          The menu on the left contains different blocks.</br>
          Move them into either the setup- or loop-block below to define a
          blockprogram.</br>
          When finished click the execute button on the bottom-right to start
          the program.<br>
          For more information on each of the blocks, check the <a
            href="docs/Blocks.md" target="_blank"
            rel="noopener noreferrer">documentation</a>.
        </p>
        <input list="samples" type="text" id="loadWorkspace-input"
          placeholder="samples/gamble.xml">
        <datalist id="samples">
          <option value="./samples/gamble.xml"></option>
          <option value="./samples/sparqlAsk.xml"></option>
          <option value="./samples/httpRequests.xml"></option>
          <option value="./samples/event.xml"></option>
          <option value="./samples/lightsProximity.xml"></option>
          <option value="./samples/stationIncrement.xml"></option>
        </datalist>
        <button onclick="loadButtonHandler()">load</button>
        <button><a onclick="saveButtonHandler()">save</a></button>
        <div class="status">
          <span id="statusText">ready</span>
          <button onclick="resetInterpreter();resetStepUi()" id="stopButton" class="controlButtons"
            disabled>stop</button>
          <button onclick="runCode()" id="runButton"
            class="controlButtons">execute</button>
        </div>
      </td>
    </tr>
    <tr>
      <td id="blocklyArea">
      </td>
      <td id="resultsArea">
        <div id="messageBox"></div>
      </td>
    </tr>
  </table>

  <div id="blocklyDiv" style="position: absolute"></div>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox"
    style="display: none">
    <category name="Program" colour="120">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="Things" colour="270">
      <block type="things"></block>
      <block type="receiver"></block>
      <block type="ibeacon_data"></block>
    </category>
    <category name="Variables" custom="VARIABLE" colour="330"></category>
    <category name="Actions" colour="0">
      <block type="readdw"></block>
      <block type="writedw"></block>
      <block type="displayText"></block>
      <block type="displayTable"></block>
      <block type="httprequest"></block>
      <block type="sparql_query"></block>
      <block type="sparql_ask"></block>
      <block type="switchlights"></block>
      <block type="randomsound"></block>
      <block type="controls_flow_statements"></block>
      <block type="waitSeconds"></block>
    </category>
    <category name="Logic" colour="210">
      <block type="controls_if"></block>
      <block type="event"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
    </category>
    <category name="Booleans" colour="210">
      <block type="logic_boolean"></block>
    </category>
    <category name="Text" colour="160">
      <block type="uri"></block>
      <block type="mac"></block>
      <block type="text"></block>
      <block type="text_join"></block>
    </category>
    <category name="Numbers" colour="230">
      <block type="math_number"></block>
      <block type="infinity"></block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
    </category>
  </xml>
  <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks"
    style="display: none">
    <block type="controls_whileUntil" x="10" y="100">
      <value name="BOOL">
        <block type="logic_boolean"></block>
      </value>
    </block>
  </xml>

  <script>
    var messageCounter = 0;

    function displayText(text) {
      // save memory
      if (messageCounter > 100) {
        msgBox.lastChild.remove();
      }
      msg = document.createElement("div");
      msg.classList.add("message");
      msg.id = "message-" + messageCounter++;

      textNode = document.createTextNode(text);
      msg.appendChild(textNode);

      timeSpan = document.createElement("span");
      timeSpan.classList.add("time");
      timeSpan.innerHTML = new Date().toLocaleTimeString();
      msg.appendChild(timeSpan);

      msgBox = document.getElementById("messageBox");
      msgBox.insertBefore(msg, msgBox.firstChild);
    }
    displayText("Actionblock output will be displayed here");


    function displayTable(table) {
      // save memory
      if (messageCounter > 100) {
        msgBox.lastChild.remove();
      }

      if (table.length == 0) {
        displayText("empty table")
        return;
      }

      // deal with missing values
      let vars = table.reduce((list, res) => {
        for (let v in res) {
          if (list.indexOf(v) === -1) list.push(v);
        }
        return list;
      }, []);

      let html = '<tr>';
      vars.forEach(v => html += '<th>' + v + '</th>');
      html += '</tr>';

      table.forEach(res => {
        html += '<tr>';
        vars.forEach(v => html += '<td>' + (res[v] ? res[v].value : '') + '</td>');
        html += '</tr>';
      });

      let resultsField = document.createElement("table");
      resultsField.innerHTML = html;
      var msgBox = document.getElementById("messageBox");
      msgBox.insertBefore(resultsField, msgBox.firstChild);
    }


    /*  
    ################
    # BLOCKLY CODE # 
    ################
    */

    var runButton = document.getElementById('runButton');
    var stopButton = document.getElementById('stopButton');
    var statusText = document.getElementById('statusText');
    var myInterpreter = null;
    var runner;
    var blocklyArea = document.getElementById('blocklyArea');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var workspace = Blockly.inject(blocklyDiv, { toolbox: document.getElementById('toolbox') });

    var onresize = function (e) {
      // Compute the absolute coordinates and dimensions of blocklyArea.
      var element = blocklyArea;
      var x = 0;
      var y = 0;
      do {
        x += element.offsetLeft;
        y += element.offsetTop;
        element = element.offsetParent;
      } while (element);
      // Position blocklyDiv over blocklyArea.
      blocklyDiv.style.left = x + 'px';
      blocklyDiv.style.top = y + 'px';
      blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
      blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
      Blockly.svgResize(workspace);
    };
    window.addEventListener('resize', onresize, false);
    onresize();
    Blockly.svgResize(workspace);

    var highlightPause = false;
    var latestCode = '';

    function highlightBlock(id) {
      workspace.highlightBlock(id);
      highlightPause = true;
    }

    function resetStepUi() {
      workspace.highlightBlock(null);
      highlightPause = false;
      runButton.disabled = '';
      stopButton.disabled = 'disabled';
      setStatusText("ready")
    }

    function setStatusText(status) {
      statusText.innerHTML = status;
    }

    function generateCodeAndLoadIntoInterpreter() {
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      // Generate JavaScript code and parse it.
      latestCode = Blockly.JavaScript.workspaceToCode(workspace);
      resetStepUi();
    }

    function resetInterpreter() {
      myInterpreter = null;
      if (runner) {
        clearTimeout(runner);
        runner = null;
      }
    }

    function runCode() {
      if (!myInterpreter) {
        // First statement of this code.
        // Clear the program output.
        resetStepUi();
        runButton.disabled = 'disabled';
        stopButton.disabled = '';
        setStatusText("running...");

        // And then show generated code in an alert.
        // In a timeout to allow the outputArea.value to reset first.
        setTimeout(function () {
          // Begin execution
          highlightPause = false;
          myInterpreter = new Interpreter(latestCode, initApi);
          runner = function () {
            if (myInterpreter) {
              var hasMore = myInterpreter.step();
              if (hasMore) {
                // Execution is currently blocked by some async call.
                // Try again later.
                setTimeout(runner, 5);
              } else {
                // Program is complete.
                resetInterpreter();
                resetStepUi();
              }
            }
          };
          runner();
        }, 1);
        return;
      }
    }

    // Load the interpreter now, and upon future changes.
    generateCodeAndLoadIntoInterpreter();
    workspace.addChangeListener(function (event) {
      if (!(event instanceof Blockly.Events.Ui)) {
        // Something changed. Parser needs to be reloaded.
        resetInterpreter();
        generateCodeAndLoadIntoInterpreter();
      }
    });

    saveButtonHandler = async function (
      workspace, type, opt_callback) {
      Blockly.hideChaff();
      let url = document.getElementById("loadWorkspace-input").value;
      save(url);
    };

    /**
     * saves the current workspace to solid pod
     * @param {string} url new url of the workspace
     */
    function save(url) {

      var xmlDom = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
      var serializer = new XMLSerializer();
      var xmlStr = serializer.serializeToString(xmlDom);

      // send PUT request
      let xhr = new XMLHttpRequest();
      xhr.open("PUT", url);
      //xhr.setRequestHeader("Content-Type", "text/xml");

      xhr.onload = function () {
        if (xhr.readyState == 4 && (xhr.status.toString() == "200" || xhr.status.toString() == "201")) {
          Blockly.alert("workspace saved!");
        } else {
          Blockly.alert("Error saving workspace, see console for details.");
        }
      }
      xhr.send(xmlStr);
    }

    loadButtonHandler = async function () {
      Blockly.hideChaff();
      let url = document.getElementById("loadWorkspace-input").value;
      // send GET request
      let xhr = new XMLHttpRequest();
      xhr.open("GET", url);

      xhr.onload = function () {
        if (xhr.readyState == 4 && xhr.status == "200") {
          restore(xhr.response)
        } else {
          Blockly.alert("Error loading workspace, see console for details.");
        }
      }
      xhr.send();
    };

    /**
     * restores a workspace from JSON
     * @param {string} name name of the workspace
     */
    function restore(xmlText) {
      resetInterpreter();
      resetStepUi();

      // clear blocks
      Blockly.mainWorkspace.clear();

      var xmlDom = Blockly.Xml.textToDom(xmlText);
      Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xmlDom);
    }

    // Setting blocks on startup
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), Blockly.mainWorkspace);
  </script>
  <script src="js/sounds.js"></script>
</body>

</html>