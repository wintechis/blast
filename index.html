<!DOCTYPE html>
<html lang="en" xml:lang="en">

<head>
  <meta content="text/html;" charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BLAST - Block applications for things</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="apple-touch-icon" sizes="57x57" href="media/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="media/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="media/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="media/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="media/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="media/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="media/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="media/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="media/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="media/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="media/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="media/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="media/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="site.webmanifest">

  <script>
    // redirect to HTTPS
    if (location.protocol != 'https:') {
      location.replace(`https:${location.href.substring(location.protocol.length)}`);
    }

    // check if chrome on windows is used with experimental features enabled,
    // if not, redirect to prerquisite page.
    let urlParams = new URLSearchParams(window.location.search);
    let skipCheck = false;
    if (urlParams.has('skipCheck')) {
      skipCheck = true;
    }
    const isChrome = !!window.chrome;
    const isWindows = navigator.platform.toLowerCase().indexOf('win') >= 0;
    const isAndroid = navigator.userAgent.toLowerCase().indexOf('android') >= 0;
    const supportsWebBluetooth = 'bluetooth' in navigator;
    if (!skipCheck && !(isChrome && (isWindows || isAndroid) && supportsWebBluetooth)) {
       location.href = `prerequisites.html`;
    }

    // redirect mobile users to mobile site.
    // mobile check for older browsers
    const legacyIsMobileCheck = function () {
      if (navigator.userAgent.match(/Android/i) ||
      navigator.userAgent.match(/webOS/i) ||
      navigator.userAgent.match(/iPhone/i) ||
      navigator.userAgent.match(/iPad/i) ||
      navigator.userAgent.match(/iPod/i) ||
      navigator.userAgent.match(/BlackBerry/i) ||
      navigator.userAgent.match(/Windows Phone/i)) {
        return true;
    }
    return false;
    }

    // mobile check for newer browsers
    const uaDataIsMobile = window.navigator.userAgentData?.mobile

    // if either mobile check is true, redirect to mobile site.
    const isMobile = typeof uaDataIsMobile === 'boolean'
      ? uaDataIsMobile
      : legacyIsMobileCheck()
    if (isMobile) {
      window.location.replace("mobile/index.html");
    }
  </script>
  <!-- Joy Con WebHid implementation (https://github.com/tomayac/joy-con-webhid) -->
  <script src="js/lib/joy-con-webhid.js"></script>

  <!-- Stream Deck webHID implementation (https://github.com/Julusian/node-elgato-stream-deck) -->
  <script src="js/lib/stream-deck.js"></script>

  <!-- FileSaver.js used to open a save as interface in all browsers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"
    integrity="sha512-csNcFYJniKjJxRWRV1R7fvnXrycHP6qDR21mgz1ZP55xY5d+aHLfo9/FcGDQLfn2IfngbAHd8LdfsagcCqgTcQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  
  <!-- JS Interpreter -->
  <script src="js/lib/JSInterpreter/acorn.js"></script>
  <script src="js/lib/JSInterpreter/interpreter.js"></script>

  <!-- blockly with js generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/blockly_compressed.min.js"
    integrity="sha512-iqNC/BA2OwsMa0EMB4Xnxm7i+Y38C5j26CjgG/prCg74ILAJomPIIyp+I45hVfV9A50vnaGoh808fu6GaGAuHw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/msg/en.min.js"
    integrity="sha512-CcZSuOhlsHqLLiF3M8hvMc8aWqTE36GEaE/cP7HMNOSZytGihNqhQxFzkXigYQp4psZWCVjEXY2oYFN4+vLAYg=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/blocks_compressed.min.js"
    integrity="sha512-2EDgchO+DLca8kTvZv5NGY57nB+fH3DelW4qIKEW94cUy+UpgHNdpO6GCSxUtGYuG6ny7f2fssqCIrlN3WrHvw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/5.20210325.1/javascript_compressed.min.js"
    integrity="sha512-ATkMUjg1QwPS8AgpyN53xYVsIlqlYa8N3jxp0XYLRxdCXxzh1LmC+WmpilE/E9sFX1RVdxidf2bFI9O8Pl5bUw=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>

  <!-- urdf -->
  <script src="js/lib/urdf/urdf-browser.js"></script>

  <!-- blast libraries -->
  <script src="./blast-10e392d728.min.js"></script>
</head>

<body>
  <table id="outerTable">
    <tr id="headerTr">
      <td colspan=2>
        <table width="100%">
          <tr id="tabRow">
            <td id="tab_workspace" class="tabon">Workspace</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_javascript" class="taboff">JavaScript</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_xml" class="taboff">XML</td>
            <td class="tabmin">&nbsp;</td>
            <td id="inputs_td" class="tabmin">
              <input list="samples" type="text" id="loadWorkspace-input"
                placeholder="save to or load from URI">
              <datalist id="samples">
                <option value="samples/events.xml"></option>
                <option value="samples/gamble.xml"></option>
                <option value="samples/hello-world"></option>
                <option value="samples/playAudio.xml"></option>
                <option value="samples/requests.xml"></option>
                <option value="samples/rgbLights.xml"></option>
                <option value="samples/ruuviProperties.xml"></option>
                <option value="samples/rygLights.xml"></option>
                <option value="samples/signalStrength.xml"></option>
                <option value="samples/sounds.xml"></option>
                <option value="samples/streamdeck.xml"></option>
                <option value="samples/toggle.xml"></option>
                <option value="samples/webSpeech.xml"></option>
                <option value="samples/useCases/anti-theft-alarm.xml"></option>
                <option value="samples/useCases/timer.xml"></option>
              </datalist>
            </td>
            <td class="tabmin">
              <button id="UriLoadButton" title="load workspace">
                <span class="icon material-icons">
                  cloud_download
                  </span>
              </button>
              <button id="UriSaveButton" title="save workspace">
                <span class="icon material-icons">
                  cloud_upload
                  </span>
              </button>
            </td>
            <td class="tabmin">&nbsp;</td>
            <td class="tabmin">
              <input type="file" id="file-selector" accept=".xml">
              <button id="saveButton" title="save workspace">
                <span class="icon material-icons">
                  save
                  </span>
              </button>
            </td>
            <td class="tabmax">
              <span id="statusContainer">ready</span>
              <button id="runButton" class="primary" title="Run the program">
                <span class="material-icons">
                  play_arrow
                </span>
              </button>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td id="content_area">
      </td>
      <td id="output_area">
        <div id="msgOutputContainer">
        </div>
      </td>
    </tr>
  </table>

    <!-- Reconnect Modal -->
    <div id="rcModal" class="modal">
      <div class="modal-content">
        <span id ="rcClose" class="close">&times;</span>
        <h1>Please connect these devices to load the Program:</h1>
        <hr>     
        <div class="row" id="reconnect-row">
          <div class="col">
            <table id="rc-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Pair</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="rc-tbody">
              </tbody>
            </table>
            <br>
            <input type="button" id="rc-cancel" value="cancel">
            <input type="button" id="rc-done" data-hasEvent="" value="done" disabled>
          </div>
        </div>
      </div>
    </div>

  <div id="content_workspace" class="content"></div>
  <pre id="content_javascript" class="content prettyprint lang-js"></pre>
  <textarea id="content_xml" class="content" wrap="off"></textarea>
</body>
<script>
  // Add service worker to the page
  window.addEventListener('load', function() {
    if (navigator.serviceWorker) {
      navigator.serviceWorker.register('sw.js', { scope: './' });
    }
  });

  /**
   * Load XML from file.
   */
  const fileSelector = document.getElementById('file-selector');
  fileSelector.addEventListener('change', Blast.Storage.loadXMLFromFile);

  /**
   * Reconnect modal methods
   */
  const rcClose = document.getElementById("rcClose");
  const rcModal = document.getElementById("rcModal");

  rcClose.onclick = function () {
    rcModal.style.display = "none";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function (event) {
    if (event.target == rcModal) {
      rcModal.style.display = "none";
    }
  }
</script>
</html>
