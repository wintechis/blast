<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: blast_things.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: blast_things.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Utility functions for handling things.
 * @author derwehr@gmail.com (Thomas Wehr)
 * @license https://www.gnu.org/licenses/agpl-3.0.de.html AGPLv3
 */

'use strict';

import {throwError} from './blast_interpreter.js';
import {getWorkspace} from './blast_interpreter.js';


/**
 * Maps device names to BluetoothDevice.id.
 */
const webBluetoothDevices = new Map();

/**
 * Maps user defined names to webHID identifiers.
 */
const webHidNames = new Map();

/**
 * Maps webHID identifiers to webHID devices.
 */
const webHidDevices = new Map();

let webBluetoothButtonHandler = null;
export const setWebBluetoothButtonHandler = function(handler) {
  webBluetoothButtonHandler = handler;
};

/**
 * Default method for logging device interaction.
 * @param {string} message The message to log.
 * @param {string=} adapter The name of the adapter that generated the message.
 * @param {string=} device The name of the device that generated the message.
 */
let thingsLog = function(message, adapter, device) {
  console.log({adapter}, {device}, message);
};
/**
 * Getter for the thingsLog function.
 * @return {Function} The thingsLog function.
 */
export const getThingsLog = function() {
  return thingsLog;
};
/**
 * Setter for the thingsLog function.
 * @param {Function} logFunc The function to use for logging.
 */
export const setThingsLog = function(logFunc) {
  thingsLog = logFunc;
};


/**
 * Resets all device maps.
 */
export const resetThings = function() {
  webBluetoothDevices.clear();
  webHidNames.clear();
  webHidDevices.clear();
};

export const getWebHidDevice = function(deviceId) {
  return webHidDevices.get(deviceId);
};

/**
 * Construct the elements (blocks and buttons) required by the flyout for the
 * things category.
 * @param {!Blockly.Workspace} workspace The workspace containing things.
 * @return {!Array.&lt;!Element>} Array of XML elements.
 */
export const thingsFlyoutCategory = function(workspace) {
  let xmlList = [];

  // Create WebBluetooth Label
  const webBluetoothLabel = document.createElement('label');
  webBluetoothLabel.setAttribute('text', 'WebBluetooth Blocks');
  xmlList.push(webBluetoothLabel);

  // Create WebBluetooth add device button
  const webBluetoothButton = document.createElement('button');
  webBluetoothButton.setAttribute('text', 'pair via webBluetooth');
  webBluetoothButton.setAttribute('callbackKey', 'CREATE_WEBBLUETOOTH');
  workspace.registerButtonCallback('CREATE_WEBBLUETOOTH', function(_button) {
    webBluetoothButtonHandler();
  });
  xmlList.push(webBluetoothButton);

  
  // add webBluetooth blocks to xmlList
  const wbBlockList = flyoutCategoryBlocksWB(workspace);
  xmlList = xmlList.concat(wbBlockList);
  
  // Create WebBluetooth Label
  const webHIDLabel = document.createElement('label');
  webHIDLabel.setAttribute('text', 'WebHID Blocks');
  xmlList.push(webHIDLabel);

  // Create WebBluetooth add device button
  const webHidbutton = document.createElement('button');
  webHidbutton.setAttribute('text', 'connect via webHID');
  webHidbutton.setAttribute('callbackKey', 'CREATE_WEBHID');
  workspace.registerButtonCallback('CREATE_WEBHID', function(_button) {
    createWebHidButtonHandler();
  });
  xmlList.push(webHidbutton);

  // add webHID blocks to xmlList
  const wHidBlockList = flyoutCategoryBlocksWHid(workspace);
  xmlList = xmlList.concat(wHidBlockList);

  // Create identifiers label
  const identifiersLabel = document.createElement('label');
  identifiersLabel.setAttribute('text', 'additional identifiers');
  xmlList.push(identifiersLabel);

  // add uri block to xmlList
  let block = Blockly.utils.xml.createElement('block');
  block.setAttribute('type', 'uri');
  xmlList.push(block);

  // add uri_from_string block to xmlList
  block = Blockly.utils.xml.createElement('block');
  block.setAttribute('type', 'uri_from_string');
  xmlList.push(block);

  // temporarily comment out unused mac block, see #69
  // block = Blockly.utils.xml.createElement('block');
  // block.setAttribute('type', 'mac');
  // xmlList.push(block);

  // create audio uris label
  const audioLabel = document.createElement('label');
  audioLabel.setAttribute('text', 'example audio URIs');
  xmlList.push(audioLabel);

  // add audio uri blocks to xmlList
  const audioURIs = [
    'https://studio.code.org/blockly/media/skins/dance/win.mp3',
    'https://studio.code.org/blockly/media/click.mp3',
    'https://upload.wikimedia.org/wikipedia/commons/2/25/243020_plasterbrain_game-start.ogg',
    'https://upload.wikimedia.org/wikipedia/commons/d/d9/Wilhelm_Scream.ogg',
  ];
  for (const audioURI of audioURIs) {
    const block = Blockly.utils.xml.createElement('block');
    block.setAttribute('type', 'uri');
    const field = Blockly.utils.xml.createElement('field');
    field.setAttribute('name', 'URI');
    field.textContent = audioURI;
    block.appendChild(field);
    xmlList.push(block);
  }

  return xmlList;
};


/**
 * Construct the webBluetooth blocks required by the flyout for the things category.
 * @return {!Array.&lt;!Element>} Array of XML block elements.
 */
const flyoutCategoryBlocksWHid = function() {
  const xmlList = [];

  // add webHID devices to xmlList
  if (webHidDevices.size > 0) {
    if (Blockly.Blocks['things_webHID']) {
      const block = Blockly.utils.xml.createElement('block');
      block.setAttribute('type', 'things_webHID');
      block.setAttribute('gap', 8);
      xmlList.push(block);
    }
  }

  return xmlList;
};

/**
 * Construct the webHIDh blocks required by the flyout for the things category.
 * @return {!Array.&lt;!Element>} Array of XML block elements.
 */
const flyoutCategoryBlocksWB = function() {
  const xmlList = [];

  // add webBluetooth devices to xmlList
  if (webBluetoothDevices.size > 0) {
    if (Blockly.Blocks['things_webBluetooth']) {
      const block = Blockly.utils.xml.createElement('block');
      block.setAttribute('type', 'things_webBluetooth');
      block.setAttribute('gap', 8);
      xmlList.push(block);
    }
  }

  return xmlList;
};

/**
 * Returns an Array containing tuples of device names and their identifier.
 * @returns {Array.&lt;string, string>} Array containing tuples of device names and their identifier.
 * @example [['beacon', 'm+JZZGVo+aDUb0a4NOpQWw==']]
 */
export const getWebBluetoothDevices = function() {
  const keysArray = [...webBluetoothDevices.keys()];
  const keysSorted = keysArray.sort();

  // if no devices connected, return empty array
  if (keysSorted.legnth === 0) return [];

  // build options array
  const options = [];
  for (const deviceName of keysSorted) {
    const deviceId = webBluetoothDevices.get(deviceName);
    options.push([deviceName, deviceId]);
  }

  return options;
};

/**
 * Returns an Array containing tuples of device names and their identifier.
 * @returns {Array.&lt;string, string>} Array containing tuples of device names and their identifier.
 * @example [['beacon', 'm+JZZGVo+aDUb0a4NOpQWw==']]
 */
export const getWebHIDDevices = function() {
  const keysArray = [...webHidNames.keys()];
  const keysSorted = keysArray.sort();

  // if no devices connected, return empty array
  if (keysSorted.legnth === 0) return [];

  // build options array
  const options = [];
  for (const deviceName of keysSorted) {
    const deviceId = webHidNames.get(deviceName);
    options.push([deviceName, deviceId]);
  }

  return options;
};

/**
 * Adds a WebBluetooth device to the {@link webBluetoothDevices} map.
 * @param {BluetoothDevice.id} webBluetoothId A DOMString that uniquely identifies a device.
 * @param {string} deviceName User defined name for the device.
 */
export const addWebBluetoothDevice = function(webBluetoothId, deviceName) {
  // This function needs to be named so it can be called recursively.
  const promptAndCheckWithAlert = function(name, id) {
    Blockly.Variables.promptName('Pair successful! Now give your device a name.', name,
        function(text) {
          if (text) {
            const existing =
                  webBluetoothDevices.has(text);
            if (existing) {
              const msg = 'Name %1 already exists'.replace(
                  '%1', text);
              Blockly.alert(msg,
                  function() {
                    promptAndCheckWithAlert(text, id);  // Recurse
                  });
            } else {
              // No conflict
              webBluetoothDevices.set(text, id);
            }
          } else {
            const msg = 'Name cannot be empty';
            Blockly.alert(msg, function() {
              promptAndCheckWithAlert(text, id); // Recuse
            });
          }
        });
  };
  promptAndCheckWithAlert(deviceName, webBluetoothId);
};


/**
 * Handles "connect via webHID" button in the things toolbox category.
 */
const createWebHidButtonHandler = function() {
  const workspace = getWorkspace();
  thingsLog('Requesting webHID device...', 'HID');
  navigator.hid.requestDevice({filters: []})
      .then((device) => {
        if (device.length === 0) {
          throwError('Connection failed or cancelled by User.');
          return;
        }
        // generate a unique id for the new device
        const uid = Date.now().toString(36) + Math.random().toString(36).substring(2);
        // add device to the device map with its uid
        addWebHidDevice(uid, device[0].productName, device[0]);
        workspace.refreshToolboxSelection();
        thingsLog('Connected', 'HID', device[0].productName);
      })
      .catch((error) => {
        throwError(error);
      });
};

/**
 * Creates user defined identifier to get devices from {@link webHidDevices}.
 * @param {strubg} uid identifier of the device in {@link webHidDevices}.
 * @param {string} deviceName default name for the device.
 * @param {HIDDevice} device the device to add.
 */
export const addWebHidDevice = function(uid, deviceName, device) {
  // This function needs to be named so it can be called recursively.
  const promptAndCheckWithAlert = function(name, id) {
    Blockly.Variables.promptName('Connection established! Now give your device a name.', name,
        function(text) {
          if (text) {
            const existing =
                  webHidNames.has(text);
            if (existing) {
              const msg = 'Name %1 already exists'.replace(
                  '%1', text);
              Blockly.alert(msg,
                  function() {
                    promptAndCheckWithAlert(text, id);  // Recurse
                  });
            } else {
              // No conflict
              webHidDevices.set(id, device);
              webHidNames.set(text, id);
            }
          } else {
            const msg = 'Name cannot be empty';
            Blockly.alert(msg, function() {
              promptAndCheckWithAlert(text, id); // Recuse
            });
          }
        });
  };
  promptAndCheckWithAlert(deviceName, uid);
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#%255B0%255D">[0]</a></li><li><a href="global.html#addBlock">addBlock</a></li><li><a href="global.html#addElementToOutputContainer">addElementToOutputContainer</a></li><li><a href="global.html#addEventCode">addEventCode</a></li><li><a href="global.html#addEventListener">addEventListener</a></li><li><a href="global.html#addMessage">addMessage</a></li><li><a href="global.html#addToLog">addToLog</a></li><li><a href="global.html#addWebBluetoothDevice">addWebBluetoothDevice</a></li><li><a href="global.html#addWebHidDevice">addWebHidDevice</a></li><li><a href="global.html#allConnectedMobile_">allConnectedMobile_</a></li><li><a href="global.html#allStates">allStates</a></li><li><a href="global.html#apiFunctions">apiFunctions</a></li><li><a href="global.html#asyncApiFunctions">asyncApiFunctions</a></li><li><a href="global.html#bindClick">bindClick</a></li><li><a href="global.html#cacheLEScanResults">cacheLEScanResults</a></li><li><a href="global.html#cleanUpFunctions">cleanUpFunctions</a></li><li><a href="global.html#clearIntervalEvents">clearIntervalEvents</a></li><li><a href="global.html#ClearLog">ClearLog</a></li><li><a href="global.html#ClearOutputContainer">ClearOutputContainer</a></li><li><a href="global.html#clipboard">clipboard</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createWebHidButtonHandler">createWebHidButtonHandler</a></li><li><a href="global.html#currentToolbox">currentToolbox</a></li><li><a href="global.html#deviceEventHandlers">deviceEventHandlers</a></li><li><a href="global.html#disableWorkspace">disableWorkspace</a></li><li><a href="global.html#disconnect">disconnect</a></li><li><a href="global.html#enableWorkspace">enableWorkspace</a></li><li><a href="global.html#eventChecker">eventChecker</a></li><li><a href="global.html#eventCode">eventCode</a></li><li><a href="global.html#eventsFlyoutCategory">eventsFlyoutCategory</a></li><li><a href="global.html#eventsInWorkspace">eventsInWorkspace</a></li><li><a href="global.html#eventValues">eventValues</a></li><li><a href="global.html#filename">filename</a></li><li><a href="global.html#findLegalName">findLegalName</a></li><li><a href="global.html#flyoutCategoryBlocksWB">flyoutCategoryBlocksWB</a></li><li><a href="global.html#flyoutCategoryBlocksWHid">flyoutCategoryBlocksWHid</a></li><li><a href="global.html#generateCode">generateCode</a></li><li><a href="global.html#generatePairButtonsMobile_">generatePairButtonsMobile_</a></li><li><a href="global.html#generatePath">generatePath</a></li><li><a href="global.html#getActiveSlot">getActiveSlot</a></li><li><a href="global.html#getAdvertisedTxPower">getAdvertisedTxPower</a></li><li><a href="global.html#getAdvertisingData">getAdvertisingData</a></li><li><a href="global.html#getAdvertisingInterval">getAdvertisingInterval</a></li><li><a href="global.html#getCapabilities">getCapabilities</a></li><li><a href="global.html#getCategory">getCategory</a></li><li><a href="global.html#getCharacteristic">getCharacteristic</a></li><li><a href="global.html#getDefinition">getDefinition</a></li><li><a href="global.html#getDeviceById">getDeviceById</a></li><li><a href="global.html#getInterpreter">getInterpreter</a></li><li><a href="global.html#getInterrupted">getInterrupted</a></li><li><a href="global.html#getLatestCode">getLatestCode</a></li><li><a href="global.html#getLockState">getLockState</a></li><li><a href="global.html#getPrimaryService">getPrimaryService</a></li><li><a href="global.html#getPublicECDHKey">getPublicECDHKey</a></li><li><a href="global.html#getStdError">getStdError</a></li><li><a href="global.html#getStdInfo">getStdInfo</a></li><li><a href="global.html#getStdOut">getStdOut</a></li><li><a href="global.html#getThingsLog">getThingsLog</a></li><li><a href="global.html#getTxPowerLevel">getTxPowerLevel</a></li><li><a href="global.html#getWebBluetoothDevices">getWebBluetoothDevices</a></li><li><a href="global.html#getWebHIDDevices">getWebHIDDevices</a></li><li><a href="global.html#getWorkspace">getWorkspace</a></li><li><a href="global.html#hexStringToArrayBuffer">hexStringToArrayBuffer</a></li><li><a href="global.html#highlightBlock">highlightBlock</a></li><li><a href="global.html#HTTPREQUEST_ERROR">HTTPREQUEST_ERROR</a></li><li><a href="global.html#importPrettify">importPrettify</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initApi">initApi</a></li><li><a href="global.html#initInterpreter">initInterpreter</a></li><li><a href="global.html#initStatesInterpreter">initStatesInterpreter</a></li><li><a href="global.html#initUi">initUi</a></li><li><a href="global.html#interpreter">interpreter</a></li><li><a href="global.html#interrupted">interrupted</a></li><li><a href="global.html#intervalEvents">intervalEvents</a></li><li><a href="global.html#isLEScanRunning">isLEScanRunning</a></li><li><a href="global.html#isNameUsed">isNameUsed</a></li><li><a href="global.html#latestCode">latestCode</a></li><li><a href="global.html#LEScanResults">LEScanResults</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#LINK_ALERT">LINK_ALERT</a></li><li><a href="global.html#messageOutputContainer">messageOutputContainer</a></li><li><a href="global.html#NOT_FOUND_ERROR">NOT_FOUND_ERROR</a></li><li><a href="global.html#onStatusChange">onStatusChange</a></li><li><a href="global.html#optionalServices">optionalServices</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#readHex">readHex</a></li><li><a href="global.html#readNumber">readNumber</a></li><li><a href="global.html#readText">readText</a></li><li><a href="global.html#reconnectCancelHandler_">reconnectCancelHandler_</a></li><li><a href="global.html#removeDeviceHandlers">removeDeviceHandlers</a></li><li><a href="global.html#removeEventCode">removeEventCode</a></li><li><a href="global.html#removeEventListener">removeEventListener</a></li><li><a href="global.html#rename">rename</a></li><li><a href="global.html#requestDevice">requestDevice</a></li><li><a href="global.html#resetFileInput">resetFileInput</a></li><li><a href="global.html#resetInterpreter">resetInterpreter</a></li><li><a href="global.html#resetStateInterpreter">resetStateInterpreter</a></li><li><a href="global.html#resetThings">resetThings</a></li><li><a href="global.html#resetUi">resetUi</a></li><li><a href="global.html#runButton">runButton</a></li><li><a href="global.html#runJS">runJS</a></li><li><a href="global.html#scanBlocks">scanBlocks</a></li><li><a href="global.html#setActiveSlot">setActiveSlot</a></li><li><a href="global.html#setAdvertisedTxPower">setAdvertisedTxPower</a></li><li><a href="global.html#setAdvertisingData">setAdvertisingData</a></li><li><a href="global.html#setAdvertisingInterval">setAdvertisingInterval</a></li><li><a href="global.html#setInterrupted">setInterrupted</a></li><li><a href="global.html#setStatus">setStatus</a></li><li><a href="global.html#setStdError">setStdError</a></li><li><a href="global.html#setStdInfo">setStdInfo</a></li><li><a href="global.html#setStdOut">setStdOut</a></li><li><a href="global.html#setThingsLog">setThingsLog</a></li><li><a href="global.html#setTxPowerLevel">setTxPowerLevel</a></li><li><a href="global.html#startEventChecker">startEventChecker</a></li><li><a href="global.html#startLEScan">startLEScan</a></li><li><a href="global.html#stateInterpreter">stateInterpreter</a></li><li><a href="global.html#statesInterpreterRunning">statesInterpreterRunning</a></li><li><a href="global.html#status">status</a></li><li><a href="global.html#statusContainer">statusContainer</a></li><li><a href="global.html#statusValues">statusValues</a></li><li><a href="global.html#stdErr">stdErr</a></li><li><a href="global.html#stdInfo">stdInfo</a></li><li><a href="global.html#stdOut">stdOut</a></li><li><a href="global.html#stopJS">stopJS</a></li><li><a href="global.html#stopLEScan">stopLEScan</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#tearDown">tearDown</a></li><li><a href="global.html#thingsFlyoutCategory">thingsFlyoutCategory</a></li><li><a href="global.html#thingsLog">thingsLog</a></li><li><a href="global.html#throwError">throwError</a></li><li><a href="global.html#UUIDS">UUIDS</a></li><li><a href="global.html#webBluetoothDevices">webBluetoothDevices</a></li><li><a href="global.html#webHidDevices">webHidDevices</a></li><li><a href="global.html#webHidNames">webHidNames</a></li><li><a href="global.html#workspace">workspace</a></li><li><a href="global.html#writeWithoutResponse">writeWithoutResponse</a></li><li><a href="global.html#writeWithResponse">writeWithResponse</a></li><li><a href="global.html#XML_ERROR">XML_ERROR</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Mon Jan 24 2022 10:04:12 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
