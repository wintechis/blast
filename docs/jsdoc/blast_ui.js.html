<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: blast_ui.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: blast_ui.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Blast UI variables and methods.
 * @author derwehr@gmail.com (Thomas Wehr)
 * @license https://www.gnu.org/licenses/agpl-3.0.de.html AGPLv3
 */

'use strict';

import {getLatestCode} from './blast_interpreter.js';
import {loadXMLFromFile} from './blast_storage.js';
import {link} from './blast_storage.js';
import {onStatusChange} from './blast_interpreter.js';
import {runJS} from './blast_interpreter.js';
import {setStdError} from './blast_interpreter.js';
import {setStdInfo} from './blast_interpreter.js';
import {setStdOut} from './blast_interpreter.js';
import {setThingsLog} from './blast_things.js';
import {statusValues} from './blast_interpreter.js';
import {stopJS} from './blast_interpreter.js';


/**
 * List of tab names.
 * @type {Array.&lt;string>}
 * @private
 */
export const TABS_ = ['workspace', 'javascript', 'xml', 'deviceLogs'];

/**
 * Name of currently selected tab.
 * @type {string}
 * @private
 */
let selected_ = 'workspace';

/**
 * Play icon used for the start/stop button.
 * @type {HTMLElement}
 * @private
 */
const playIcon_ = '&lt;span class="icon material-icons">play_arrow&lt;/span>';

/**
 * Stop icon used for the start/stop button.
 * @type {HTMLElement}
 * @private
 */
const stopIcon_ = '&lt;span class="icon material-icons">stop&lt;/span>';

/**
 * Number of messages in the Message Output Container.
 * @type {number}
 * @private
 */
let messageCounter_ = 0;

/**
 * Message output Container.
 * @type {?HTMLElement}
 * @public
 */
let messageOutputContainer = null;

/**
 * Container displaying Blast's current status.
 * @type {?HTMLElement}
 * @public
 */
let statusContainer = null;

/**
 * Button to start/stop execution of the user's code.
 * @type {?HTMLElement}
 * @public
 */
let runButton = null;

/**
 * The workspace used to display the user's code.
 */
let workspace = null;

/**
 * Bind a function to a button's click event.
 * @param {!Element|string} el Button element or ID thereof.
 * @param {!Function} func func Event handler to bind.
 * @public
 */
export const bindClick = function(el, func) {
  if (typeof el == 'string') {
    el = document.getElementById(el);
  }
  el.addEventListener('click', func, true);
  el.addEventListener('touchend', func, true);
};


/**
 * Set the start/stop button and status text.
 * @param {Blast.Interpreter.statusValues} val new Blast status text.
 * @public
 */
const setStatus = function(val) {
  let icon;
  let func;
  let title;
  if (val === statusValues.RUNNING) {
    func = stopJS;
    icon = stopIcon_;
    title = 'Stop the execution';
  } else {
    func = runJS;
    icon = playIcon_;
    title = 'Run block program';
  }

  // Set start/stop button click event and icon
  runButton.onclick = func;
  runButton.title = title;
  runButton.innerHTML = icon;
  // set status text
  statusContainer.innerHTML = val;
};
onStatusChange.stopped.push(() => setStatus(statusValues.STOPPED));
onStatusChange.running.push(() => setStatus(statusValues.RUNNING));

/**
 * Reset the UI.
 * @param {Blast.Interpreter.statusValues} val new Blast status text.
 * @public
 */
const resetUi = function(val) {
  // remove highlighting
  workspace.highlightBlock(null);
  // set Blast stauts
  setStatus(val);
};
onStatusChange.stopped.push(() => resetUi(statusValues.STOPPED));
onStatusChange.running.push(() => resetUi(statusValues.RUNNING));
onStatusChange.ready.push(() => resetUi(statusValues.READY));
onStatusChange.error.push(() => resetUi(statusValues.ERROR));

/**
 * Adds a DOM Element to the {@link messageOutputContainer}.
 * @param {HTMLElement} elem the element to be added
 */
export const addElementToOutputContainer = function(elem) {
  // Limit elements to 100
  if (messageCounter_ > 100) {
    messageOutputContainer.firstChild.remove();
  }

  // insert new element
  messageOutputContainer.appendChild(elem, messageOutputContainer.firstChild);

  // scroll to bottom of container
  messageOutputContainer.scrollTop = messageOutputContainer.scrollHeight;
};

/**
 * Creates a message element and adds it to the {@link messageOutputContainer}.
 * @param {string} message the message to be added
 * @param {string=} type optional, type of the message, can be 'error', 'warning', or 'info'
 * @public
 */
const addMessage = function(message, type) {
  // Send notification if window is not focused.
  let icon = 'media/logo-512x512.png';
  if (window.location.href.includes('mobile')) {
    icon = '../' + icon;
  }
  if (!document.hasFocus()) {
    navigator.serviceWorker.ready.then(function(registration) {
      registration.showNotification('Blast', {
        body: message,
        icon: icon,
        vibrate: [200, 100, 200, 100, 200, 100, 200],
      });
    });
  }

  // container for the new message
  const msg = document.createElement('div');
  msg.classList.add('message');
  if (type) {
    msg.classList.add(`${type}-message`);
  }
  msg.id = 'message-' + messageCounter_++;

  const textNode = document.createTextNode(message);
  msg.appendChild(textNode);

  const timeSpan = document.createElement('span');
  timeSpan.classList.add('time');
  timeSpan.innerHTML = new Date().toLocaleTimeString();
  msg.appendChild(timeSpan);

  const displaySystemInformation = function() {
    const debugInfo = document.getElementById('debugModal');
    debugInfo.style.display = 'block';
    const debugTbody = document.getElementById('debug-tbody');
    debugTbody.innerHTML = '';
    // Get current BLAST revision
    const revisionRow = document.createElement('tr');
    revisionRow.innerHTML = `&lt;td>BLAST&lt;/td>&lt;td>${rev}&lt;/td>`;
    debugTbody.appendChild(revisionRow);
  
    // System information
    for (const key in navigator) {
      if (typeof(navigator[key]) === 'string') {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        const td2 = document.createElement('td');
        td1.innerHTML = key;
        td2.innerHTML = navigator[key];
        tr.appendChild(td1);
        tr.appendChild(td2);
        debugTbody.appendChild(tr);
      }
    }
  };

  if (type === 'error') {
    const debugInfo = document.createElement('span');
    debugInfo.classList.add('debug-info');
    const openDebugInfo = document.createElement('a');
    openDebugInfo.innerHTML = 'show debug info';
    openDebugInfo.href = '#';
    openDebugInfo.onclick = displaySystemInformation;
    debugInfo.appendChild(openDebugInfo);
    msg.appendChild(debugInfo);
  }

  addElementToOutputContainer(msg);
};
setStdError((message) => addMessage(message, 'error'));
setStdInfo((message) => addMessage(message, 'info'));
setStdOut((message) => addMessage(message));

/**
 * Switch the visible pane when a tab is clicked.
 * @param {string} clickedName Name of tab clicked.
 * @private
 */
const tabClick_ = function(clickedName) {
  // Deselect all tabs and hide all panes.
  for (const name of TABS_) {
    const tab = document.getElementById('tab_' + name);
    tab.classList.add('taboff');
    tab.classList.remove('tabon');
    document.getElementById('content_' + name).style.visibility = 'hidden';
  }

  // Select the active tab.
  selected_ = clickedName;
  const selectedTab = document.getElementById('tab_' + clickedName);
  selectedTab.classList.remove('taboff');
  selectedTab.classList.add('tabon');
  // Show the selected pane.
  document.getElementById('content_' + clickedName).style.visibility = 'visible';
  Blockly.svgResize(workspace);
};

/**
 * Populate the JS pane with pretty printed code generated from the blocks.
 * @private
 */
const renderContent_ = function() {
  // render the xml content.
  const xmlTextarea = document.getElementById('content_xml');
  const xmlDom = Blockly.Xml.workspaceToDom(workspace);
  const xmlText = Blockly.Xml.domToPrettyText(xmlDom);
  xmlTextarea.value = xmlText;
  xmlTextarea.focus();

  // render the JavaScript content.
  const content = document.getElementById('content_javascript');

  // remove highlightblock functions from the js code tab
  content.textContent = getLatestCode().replace(/highlightBlock\('.*'\);\n/gm, '');
  // Remove the 'prettyprinted' class, so that Prettify will recalculate.
  content.className = content.className.replace('prettyprinted', '');
  if (typeof PR == 'object') {
    PR.prettyPrint();
  }
};

/**
 * Adds a message to the device log tab.
 * @param {string} msg Text to add to the log.
 * @param {string=} adapter The name of the adapter that generated the message.
 * @param {string=} device The name of the device that generated the message.
 */
const addToLog = function(msg, adapter, device) {
  const log = document.getElementById('content_deviceLogs');
  // Create a new log item.
  const logItem = document.createElement('div');
  logItem.className = 'logItem';

  // Add adapter and device if specified.
  if (adapter) {
    const adapterName = document.createElement('span');
    adapterName.classList.add('log-adapter');
    if (adapter.toLowerCase() === 'bluetooth') {
      adapterName.textContent = 'Bluetooth';
      adapterName.classList.add('log-bluetooth');
    } else if (adapter.toUpperCase() === 'HID') {
      adapterName.textContent = 'HID';
      adapterName.classList.add('log-hid');
    } else if (adapter.toLowerCase() === 'eddystone') {
      adapterName.textContent = 'Eddystone';
      adapterName.classList.add('log-eddystone');
    } else {
      adapterName.textContent = adapter;
    }
    logItem.appendChild(adapterName);
  }
  if (device) {
    const deviceName = document.createElement('span');
    deviceName.classList.add('log-device');
    deviceName.textContent = device;
    logItem.appendChild(deviceName);
  }

  // Generate timestamp.
  const date = new Date();
  const time = ('0' + date.getHours()).slice(-2) + ':' +
      ('0' + date.getMinutes()).slice(-2) + ':' +
      ('0' + date.getSeconds()).slice(-2);
  const timestamp = '[' + time + '] ';
  const timestampSpan = document.createElement('span');
  timestampSpan.classList.add('log-timestamp');
  timestampSpan.textContent = timestamp;
  logItem.appendChild(timestampSpan);
  // Generate the message
  const msgSpan = document.createElement('span');
  msgSpan.classList.add('log-message');
  msgSpan.innerHTML = msg;
  logItem.appendChild(msgSpan);

  // Add log item to the log.
  log.appendChild(logItem);
  log.scrollTop = log.scrollHeight;
};
setThingsLog((msg, adapter, device) => addToLog(msg, adapter, device));

/**
 * Removes all children from the {@link messageOutputContainer}
 */
const ClearOutputContainer = function() {
  const container = messageOutputContainer;
  while (container.lastChild.id !== 'clearOutputButton') {
    container.removeChild(container.lastChild);
  }
};

/**
 * Removes all children from the device log tab.
 */
const ClearLog = function() {
  const log = document.getElementById('content_deviceLogs');
  while (log.lastChild.id !== 'clearDeviceLogsButton') {
    log.removeChild(log.lastChild);
  }
};

/**
 * Load the Prettify CSS and JavaScript.
 * @public
 */
const importPrettify = function() {
  const script = document.createElement('script');
  script.setAttribute(
      'src',
      'https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js',
  );
  document.head.appendChild(script);
};

/**
 * Initialize the UI by binding onclick events.
 * @param {!Blockly.Workspace} ws The workspace to bind to the UI.
 */
export const initUi = function(ws) {
  workspace = ws;
  // Set remaining properties.
  runButton = document.getElementById('runButton');
  messageOutputContainer = document.getElementById('msgOutputContainer');
  statusContainer = document.getElementById('statusContainer');
  const fileSelector = document.getElementById('file-selector');
  fileSelector.addEventListener('change', loadXMLFromFile);

  // mobile website has its own tab system
  if (window.location.href.includes('mobile')) {
    return;
  }

  // Bind onClick events to tabs
  tabClick_(selected_);

  for (const name of TABS_) {
    bindClick(
        'tab_' + name,
        (function(name_) {
          return function() {
            tabClick_(name_);
          };
        })(name),
    );
  }

  // adjust workspace and toolbox on resize
  const onresize = function() {
    for (const tab of TABS_) {
      const el = document.getElementById('content_' + tab);
      el.style.top = '35px';
      el.style.left = '0px';
      // Height and width need to be set, read back, then set again to
      // compensate for scrollbars.
      el.style.height = window.innerHeight - 35 + 'px';
      el.style.width = window.innerWidth - 450 + 'px';
    }
    // Make the 'workspace' tab line up with the toolbox.
    if (workspace &amp;&amp; workspace.getToolbox().width) {
      // Account for the 19 pixel margin and on each side.
      document.getElementById('tab_workspace').style.minWidth =
              workspace.getToolbox().width - 38 + 'px';
    }
    Blockly.svgResize(workspace);
  };
  window.addEventListener('resize', onresize, false);

  onresize();
  Blockly.svgResize(workspace);

  // Call renderContent_ on changes to the workspace.
  workspace.addChangeListener(function(event) {
    if (!(event instanceof Blockly.Events.Ui)) {
      renderContent_();
    }
  });

  bindClick('saveButton', () => {
    link(true);
  });
  bindClick('clearDeviceLogsButton', ClearLog);
  bindClick('clearOutputButton', ClearOutputContainer);

  // Lazy-load the syntax-highlighting.
  window.setTimeout(importPrettify, 1);

  setStatus(statusValues.READY);
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#%255B0%255D">[0]</a></li><li><a href="global.html#addBlock">addBlock</a></li><li><a href="global.html#addElementToOutputContainer">addElementToOutputContainer</a></li><li><a href="global.html#addEventCode">addEventCode</a></li><li><a href="global.html#addEventListener">addEventListener</a></li><li><a href="global.html#addMessage">addMessage</a></li><li><a href="global.html#addToLog">addToLog</a></li><li><a href="global.html#addWebBluetoothDevice">addWebBluetoothDevice</a></li><li><a href="global.html#addWebHidDevice">addWebHidDevice</a></li><li><a href="global.html#allConnectedMobile_">allConnectedMobile_</a></li><li><a href="global.html#allStates">allStates</a></li><li><a href="global.html#apiFunctions">apiFunctions</a></li><li><a href="global.html#asyncApiFunctions">asyncApiFunctions</a></li><li><a href="global.html#bindClick">bindClick</a></li><li><a href="global.html#cacheLEScanResults">cacheLEScanResults</a></li><li><a href="global.html#cleanUpFunctions">cleanUpFunctions</a></li><li><a href="global.html#clearIntervalEvents">clearIntervalEvents</a></li><li><a href="global.html#ClearLog">ClearLog</a></li><li><a href="global.html#ClearOutputContainer">ClearOutputContainer</a></li><li><a href="global.html#clipboard">clipboard</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createWebHidButtonHandler">createWebHidButtonHandler</a></li><li><a href="global.html#currentToolbox">currentToolbox</a></li><li><a href="global.html#deviceEventHandlers">deviceEventHandlers</a></li><li><a href="global.html#disableWorkspace">disableWorkspace</a></li><li><a href="global.html#disconnect">disconnect</a></li><li><a href="global.html#enableWorkspace">enableWorkspace</a></li><li><a href="global.html#eventChecker">eventChecker</a></li><li><a href="global.html#eventCode">eventCode</a></li><li><a href="global.html#eventsFlyoutCategory">eventsFlyoutCategory</a></li><li><a href="global.html#eventsInWorkspace">eventsInWorkspace</a></li><li><a href="global.html#eventValues">eventValues</a></li><li><a href="global.html#filename">filename</a></li><li><a href="global.html#findLegalName">findLegalName</a></li><li><a href="global.html#flyoutCategoryBlocksWB">flyoutCategoryBlocksWB</a></li><li><a href="global.html#flyoutCategoryBlocksWHid">flyoutCategoryBlocksWHid</a></li><li><a href="global.html#generateCode">generateCode</a></li><li><a href="global.html#generatePairButtonsMobile_">generatePairButtonsMobile_</a></li><li><a href="global.html#generatePath">generatePath</a></li><li><a href="global.html#getActiveSlot">getActiveSlot</a></li><li><a href="global.html#getAdvertisedTxPower">getAdvertisedTxPower</a></li><li><a href="global.html#getAdvertisingData">getAdvertisingData</a></li><li><a href="global.html#getAdvertisingInterval">getAdvertisingInterval</a></li><li><a href="global.html#getCapabilities">getCapabilities</a></li><li><a href="global.html#getCategory">getCategory</a></li><li><a href="global.html#getCharacteristic">getCharacteristic</a></li><li><a href="global.html#getDefinition">getDefinition</a></li><li><a href="global.html#getDeviceById">getDeviceById</a></li><li><a href="global.html#getInterpreter">getInterpreter</a></li><li><a href="global.html#getInterrupted">getInterrupted</a></li><li><a href="global.html#getLatestCode">getLatestCode</a></li><li><a href="global.html#getLockState">getLockState</a></li><li><a href="global.html#getPrimaryService">getPrimaryService</a></li><li><a href="global.html#getPublicECDHKey">getPublicECDHKey</a></li><li><a href="global.html#getStdError">getStdError</a></li><li><a href="global.html#getStdInfo">getStdInfo</a></li><li><a href="global.html#getStdOut">getStdOut</a></li><li><a href="global.html#getThingsLog">getThingsLog</a></li><li><a href="global.html#getTxPowerLevel">getTxPowerLevel</a></li><li><a href="global.html#getWebBluetoothDevices">getWebBluetoothDevices</a></li><li><a href="global.html#getWebHIDDevices">getWebHIDDevices</a></li><li><a href="global.html#getWorkspace">getWorkspace</a></li><li><a href="global.html#hexStringToArrayBuffer">hexStringToArrayBuffer</a></li><li><a href="global.html#highlightBlock">highlightBlock</a></li><li><a href="global.html#HTTPREQUEST_ERROR">HTTPREQUEST_ERROR</a></li><li><a href="global.html#importPrettify">importPrettify</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initApi">initApi</a></li><li><a href="global.html#initInterpreter">initInterpreter</a></li><li><a href="global.html#initStatesInterpreter">initStatesInterpreter</a></li><li><a href="global.html#initUi">initUi</a></li><li><a href="global.html#interpreter">interpreter</a></li><li><a href="global.html#interrupted">interrupted</a></li><li><a href="global.html#intervalEvents">intervalEvents</a></li><li><a href="global.html#isLEScanRunning">isLEScanRunning</a></li><li><a href="global.html#isNameUsed">isNameUsed</a></li><li><a href="global.html#latestCode">latestCode</a></li><li><a href="global.html#LEScanResults">LEScanResults</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#LINK_ALERT">LINK_ALERT</a></li><li><a href="global.html#messageOutputContainer">messageOutputContainer</a></li><li><a href="global.html#NOT_FOUND_ERROR">NOT_FOUND_ERROR</a></li><li><a href="global.html#onStatusChange">onStatusChange</a></li><li><a href="global.html#optionalServices">optionalServices</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#readHex">readHex</a></li><li><a href="global.html#readNumber">readNumber</a></li><li><a href="global.html#readText">readText</a></li><li><a href="global.html#reconnectCancelHandler_">reconnectCancelHandler_</a></li><li><a href="global.html#removeDeviceHandlers">removeDeviceHandlers</a></li><li><a href="global.html#removeEventCode">removeEventCode</a></li><li><a href="global.html#removeEventListener">removeEventListener</a></li><li><a href="global.html#rename">rename</a></li><li><a href="global.html#requestDevice">requestDevice</a></li><li><a href="global.html#resetFileInput">resetFileInput</a></li><li><a href="global.html#resetInterpreter">resetInterpreter</a></li><li><a href="global.html#resetStateInterpreter">resetStateInterpreter</a></li><li><a href="global.html#resetThings">resetThings</a></li><li><a href="global.html#resetUi">resetUi</a></li><li><a href="global.html#runButton">runButton</a></li><li><a href="global.html#runJS">runJS</a></li><li><a href="global.html#scanBlocks">scanBlocks</a></li><li><a href="global.html#setActiveSlot">setActiveSlot</a></li><li><a href="global.html#setAdvertisedTxPower">setAdvertisedTxPower</a></li><li><a href="global.html#setAdvertisingData">setAdvertisingData</a></li><li><a href="global.html#setAdvertisingInterval">setAdvertisingInterval</a></li><li><a href="global.html#setInterrupted">setInterrupted</a></li><li><a href="global.html#setStatus">setStatus</a></li><li><a href="global.html#setStdError">setStdError</a></li><li><a href="global.html#setStdInfo">setStdInfo</a></li><li><a href="global.html#setStdOut">setStdOut</a></li><li><a href="global.html#setThingsLog">setThingsLog</a></li><li><a href="global.html#setTxPowerLevel">setTxPowerLevel</a></li><li><a href="global.html#startEventChecker">startEventChecker</a></li><li><a href="global.html#startLEScan">startLEScan</a></li><li><a href="global.html#stateInterpreter">stateInterpreter</a></li><li><a href="global.html#statesInterpreterRunning">statesInterpreterRunning</a></li><li><a href="global.html#status">status</a></li><li><a href="global.html#statusContainer">statusContainer</a></li><li><a href="global.html#statusValues">statusValues</a></li><li><a href="global.html#stdErr">stdErr</a></li><li><a href="global.html#stdInfo">stdInfo</a></li><li><a href="global.html#stdOut">stdOut</a></li><li><a href="global.html#stopJS">stopJS</a></li><li><a href="global.html#stopLEScan">stopLEScan</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#tearDown">tearDown</a></li><li><a href="global.html#thingsFlyoutCategory">thingsFlyoutCategory</a></li><li><a href="global.html#thingsLog">thingsLog</a></li><li><a href="global.html#throwError">throwError</a></li><li><a href="global.html#UUIDS">UUIDS</a></li><li><a href="global.html#webBluetoothDevices">webBluetoothDevices</a></li><li><a href="global.html#webHidDevices">webHidDevices</a></li><li><a href="global.html#webHidNames">webHidNames</a></li><li><a href="global.html#workspace">workspace</a></li><li><a href="global.html#writeWithoutResponse">writeWithoutResponse</a></li><li><a href="global.html#writeWithResponse">writeWithResponse</a></li><li><a href="global.html#XML_ERROR">XML_ERROR</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Mon Jan 24 2022 10:04:12 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
