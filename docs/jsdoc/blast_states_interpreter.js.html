<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: blast_states_interpreter.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: blast_states_interpreter.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview states interpreter and utility functions.
 * @author derwehr@gmail.com (Thomas Wehr)
 * @license https://www.gnu.org/licenses/agpl-3.0.de.html AGPLv3
 */
'use strict';

import {apiFunctions} from './blast_interpreter.js';
import {getInterpreter} from './blast_interpreter.js';
import {onStatusChange} from './blast_interpreter.js';
import {resetInterpreter} from './blast_interpreter.js';
import {setStatesInterpreterRunning} from './blast_interpreter.js';
import {throwError} from './blast_interpreter.js';


/**
 * Instance of the JS Interpreter checking for changing states.
 * @type {?Interpreter}
 * @public
 */
let stateInterpreter = null;

/**
 * Stores the workspace.
 */
let workspace = null;

/**
 * Instance of runner function.
 * @type {?Function}
 * @private
 */
let runner_ = null;

/**
 * latest JavaScript code generated by Blast's State and event blocks.
 * @type {string}
 * @public
 */
let latestCode = '';

/**
 * Map containing code generated by every event block.
 */
const eventCode = new Map();

/**
 * adds an event block's code to {@link eventCode}.
 * @param {Blockly.Block.id} blockId id of the event block.
 * @param {string} code code generated by the event block.
 */
export const addEventCode = function(blockId, code) {
  eventCode.set(blockId, code);
};

/**
   * removes an event block's code from {@link eventCode}.
   * @param {Blockly.Block.id} blockId id of the event block.
   */
export const removeEventCode = function(blockId) {
  eventCode.delete(blockId);
};

/**
 * Generates the code for all events a workspace.
 * @param {!Blockly.Workspace} workspace Root workspace.
 */
export const generateCode = function() {
  // event blocks are continuously checking for state condditions.
  let code = 'while (true) {\n \n}';
  
  // get all event blocks in the workspace
  const eventIds = workspace.getBlocksByType('event', false).map(function(block) {
    return block.id;
  });
  
  for (const [id, newCode] of eventCode) {
    // only add code for event blocks in the workspace
    if (eventIds.includes(id)) {
      // insert event code before the closing '\n}'
      code = code.slice(0, -2) + newCode + '\n' + code.slice(-1);
    }
  }
  // prepend generated code with variable and function definitions
  latestCode = Blockly.JavaScript.finish(code);
};

/**
 * executes {@link latestCode} using {@link Blast.Interpreter.Interpreter}.
 */
const startEventChecker = function() {
  stateInterpreter = null;
  
  // Initiate States interpreter.
  stateInterpreter = new Interpreter('');
  stateInterpreter.stateStack[0].scope = getInterpreter().globalScope;
  stateInterpreter.appendCode(latestCode);

  setStatesInterpreterRunning(true);
  
  runner_ = function() {
    if (stateInterpreter) {
      try {
        stateInterpreter.step();
        setTimeout(runner_, 1);
      } catch (error) {
        throwError('Error executing program:\n%e'.replace('%e', error));
        resetInterpreter();
        console.error(error);
      }
    }
  };
  runner_();
};
// Add startEventChecker to the interpreter api.
apiFunctions.push(['startEventChecker', startEventChecker]);

/**
 * Resets the states interpreter
 */
const resetStateInterpreter = function() {
  clearTimeout(runner_);
  runner_ = null;
  setStatesInterpreterRunning(false);
};
onStatusChange.stopped.push(resetStateInterpreter);


/**
 * Initializes the states interpreter.
 * @param {!Blockly.Workspace} ws Root workspace.
 */
export const initStatesInterpreter = function(ws) {
  workspace = ws;
  workspace.addChangeListener(function(event) {
    if (!(event instanceof Blockly.Events.Ui)) {
      // Something changed. Parser needs to be reloaded.
      generateCode();
    }
  });
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#%255B0%255D">[0]</a></li><li><a href="global.html#addBlock">addBlock</a></li><li><a href="global.html#addElementToOutputContainer">addElementToOutputContainer</a></li><li><a href="global.html#addEventCode">addEventCode</a></li><li><a href="global.html#addEventListener">addEventListener</a></li><li><a href="global.html#addMessage">addMessage</a></li><li><a href="global.html#addToLog">addToLog</a></li><li><a href="global.html#addWebBluetoothDevice">addWebBluetoothDevice</a></li><li><a href="global.html#addWebHidDevice">addWebHidDevice</a></li><li><a href="global.html#allConnectedMobile_">allConnectedMobile_</a></li><li><a href="global.html#allStates">allStates</a></li><li><a href="global.html#apiFunctions">apiFunctions</a></li><li><a href="global.html#asyncApiFunctions">asyncApiFunctions</a></li><li><a href="global.html#bindClick">bindClick</a></li><li><a href="global.html#cacheLEScanResults">cacheLEScanResults</a></li><li><a href="global.html#cleanUpFunctions">cleanUpFunctions</a></li><li><a href="global.html#clearIntervalEvents">clearIntervalEvents</a></li><li><a href="global.html#ClearLog">ClearLog</a></li><li><a href="global.html#ClearOutputContainer">ClearOutputContainer</a></li><li><a href="global.html#clipboard">clipboard</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createWebHidButtonHandler">createWebHidButtonHandler</a></li><li><a href="global.html#currentToolbox">currentToolbox</a></li><li><a href="global.html#deviceEventHandlers">deviceEventHandlers</a></li><li><a href="global.html#disableWorkspace">disableWorkspace</a></li><li><a href="global.html#disconnect">disconnect</a></li><li><a href="global.html#enableWorkspace">enableWorkspace</a></li><li><a href="global.html#eventChecker">eventChecker</a></li><li><a href="global.html#eventCode">eventCode</a></li><li><a href="global.html#eventsFlyoutCategory">eventsFlyoutCategory</a></li><li><a href="global.html#eventsInWorkspace">eventsInWorkspace</a></li><li><a href="global.html#eventValues">eventValues</a></li><li><a href="global.html#filename">filename</a></li><li><a href="global.html#findLegalName">findLegalName</a></li><li><a href="global.html#flyoutCategoryBlocksWB">flyoutCategoryBlocksWB</a></li><li><a href="global.html#flyoutCategoryBlocksWHid">flyoutCategoryBlocksWHid</a></li><li><a href="global.html#generateCode">generateCode</a></li><li><a href="global.html#generatePairButtonsMobile_">generatePairButtonsMobile_</a></li><li><a href="global.html#generatePath">generatePath</a></li><li><a href="global.html#getActiveSlot">getActiveSlot</a></li><li><a href="global.html#getAdvertisedTxPower">getAdvertisedTxPower</a></li><li><a href="global.html#getAdvertisingData">getAdvertisingData</a></li><li><a href="global.html#getAdvertisingInterval">getAdvertisingInterval</a></li><li><a href="global.html#getCapabilities">getCapabilities</a></li><li><a href="global.html#getCategory">getCategory</a></li><li><a href="global.html#getCharacteristic">getCharacteristic</a></li><li><a href="global.html#getDefinition">getDefinition</a></li><li><a href="global.html#getDeviceById">getDeviceById</a></li><li><a href="global.html#getInterpreter">getInterpreter</a></li><li><a href="global.html#getInterrupted">getInterrupted</a></li><li><a href="global.html#getLatestCode">getLatestCode</a></li><li><a href="global.html#getLockState">getLockState</a></li><li><a href="global.html#getPrimaryService">getPrimaryService</a></li><li><a href="global.html#getPublicECDHKey">getPublicECDHKey</a></li><li><a href="global.html#getStdError">getStdError</a></li><li><a href="global.html#getStdInfo">getStdInfo</a></li><li><a href="global.html#getStdOut">getStdOut</a></li><li><a href="global.html#getThingsLog">getThingsLog</a></li><li><a href="global.html#getTxPowerLevel">getTxPowerLevel</a></li><li><a href="global.html#getWebBluetoothDevices">getWebBluetoothDevices</a></li><li><a href="global.html#getWebHIDDevices">getWebHIDDevices</a></li><li><a href="global.html#getWorkspace">getWorkspace</a></li><li><a href="global.html#hexStringToArrayBuffer">hexStringToArrayBuffer</a></li><li><a href="global.html#highlightBlock">highlightBlock</a></li><li><a href="global.html#HTTPREQUEST_ERROR">HTTPREQUEST_ERROR</a></li><li><a href="global.html#importPrettify">importPrettify</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initApi">initApi</a></li><li><a href="global.html#initInterpreter">initInterpreter</a></li><li><a href="global.html#initStatesInterpreter">initStatesInterpreter</a></li><li><a href="global.html#initUi">initUi</a></li><li><a href="global.html#interpreter">interpreter</a></li><li><a href="global.html#interrupted">interrupted</a></li><li><a href="global.html#intervalEvents">intervalEvents</a></li><li><a href="global.html#isLEScanRunning">isLEScanRunning</a></li><li><a href="global.html#isNameUsed">isNameUsed</a></li><li><a href="global.html#latestCode">latestCode</a></li><li><a href="global.html#LEScanResults">LEScanResults</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#LINK_ALERT">LINK_ALERT</a></li><li><a href="global.html#messageOutputContainer">messageOutputContainer</a></li><li><a href="global.html#NOT_FOUND_ERROR">NOT_FOUND_ERROR</a></li><li><a href="global.html#onStatusChange">onStatusChange</a></li><li><a href="global.html#optionalServices">optionalServices</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#readHex">readHex</a></li><li><a href="global.html#readNumber">readNumber</a></li><li><a href="global.html#readText">readText</a></li><li><a href="global.html#reconnectCancelHandler_">reconnectCancelHandler_</a></li><li><a href="global.html#removeDeviceHandlers">removeDeviceHandlers</a></li><li><a href="global.html#removeEventCode">removeEventCode</a></li><li><a href="global.html#removeEventListener">removeEventListener</a></li><li><a href="global.html#rename">rename</a></li><li><a href="global.html#requestDevice">requestDevice</a></li><li><a href="global.html#resetFileInput">resetFileInput</a></li><li><a href="global.html#resetInterpreter">resetInterpreter</a></li><li><a href="global.html#resetStateInterpreter">resetStateInterpreter</a></li><li><a href="global.html#resetThings">resetThings</a></li><li><a href="global.html#resetUi">resetUi</a></li><li><a href="global.html#runButton">runButton</a></li><li><a href="global.html#runJS">runJS</a></li><li><a href="global.html#scanBlocks">scanBlocks</a></li><li><a href="global.html#setActiveSlot">setActiveSlot</a></li><li><a href="global.html#setAdvertisedTxPower">setAdvertisedTxPower</a></li><li><a href="global.html#setAdvertisingData">setAdvertisingData</a></li><li><a href="global.html#setAdvertisingInterval">setAdvertisingInterval</a></li><li><a href="global.html#setInterrupted">setInterrupted</a></li><li><a href="global.html#setStatus">setStatus</a></li><li><a href="global.html#setStdError">setStdError</a></li><li><a href="global.html#setStdInfo">setStdInfo</a></li><li><a href="global.html#setStdOut">setStdOut</a></li><li><a href="global.html#setThingsLog">setThingsLog</a></li><li><a href="global.html#setTxPowerLevel">setTxPowerLevel</a></li><li><a href="global.html#startEventChecker">startEventChecker</a></li><li><a href="global.html#startLEScan">startLEScan</a></li><li><a href="global.html#stateInterpreter">stateInterpreter</a></li><li><a href="global.html#statesInterpreterRunning">statesInterpreterRunning</a></li><li><a href="global.html#status">status</a></li><li><a href="global.html#statusContainer">statusContainer</a></li><li><a href="global.html#statusValues">statusValues</a></li><li><a href="global.html#stdErr">stdErr</a></li><li><a href="global.html#stdInfo">stdInfo</a></li><li><a href="global.html#stdOut">stdOut</a></li><li><a href="global.html#stopJS">stopJS</a></li><li><a href="global.html#stopLEScan">stopLEScan</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#tearDown">tearDown</a></li><li><a href="global.html#thingsFlyoutCategory">thingsFlyoutCategory</a></li><li><a href="global.html#thingsLog">thingsLog</a></li><li><a href="global.html#throwError">throwError</a></li><li><a href="global.html#UUIDS">UUIDS</a></li><li><a href="global.html#webBluetoothDevices">webBluetoothDevices</a></li><li><a href="global.html#webHidDevices">webHidDevices</a></li><li><a href="global.html#webHidNames">webHidNames</a></li><li><a href="global.html#workspace">workspace</a></li><li><a href="global.html#writeWithoutResponse">writeWithoutResponse</a></li><li><a href="global.html#writeWithResponse">writeWithResponse</a></li><li><a href="global.html#XML_ERROR">XML_ERROR</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Mon Jan 24 2022 10:04:12 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
