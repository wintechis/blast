<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: blast_interpreter.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: blast_interpreter.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview defines helper functions for the JS Interpreter and its API.
 * (https://github.com/NeilFraser/JS-Interpreter)
 * @author derwehr@gmail.com (Thomas Wehr)
 * @license https://www.gnu.org/licenses/agpl-3.0.de.html AGPLv3
 */
'use strict';

import {currentToolbox} from './blast_toolbox.js';


/**
 * Instance of the JS Interpreter.
 * @type {?Interpreter}
 * @public
 */
export let interpreter = null;

/**
 * Getter for the interpreter.
 * @return {Interpreter} the interpreter.
 */
export const getInterpreter = function() {
  return interpreter;
};

/**
 * Array of tuples, containg names and functions defined in the things folder,
 * in order to add them to the interpreter API in {@link initAPI}.
 * @public
 * @type {Array&lt;{name: string, func: Function}>}
 */
export const apiFunctions = [];

/**
  * Array of tuples, containg names and asynchronous functions defined in the
  * things folder, in order to add them to the interpreter API in {@link initAPI}.
  * @type {Array&lt;{name: string, func: Function}>}
  * @public
  */
export const asyncApiFunctions = [];

/**
  * Indicates wheter BLAST is current interrupted.
  * @type {boolean}
  * @public
  */
let interrupted = false;
/**
 * Getter for interrupted.
 * @return {boolean} interrupted
 */
export const getInterrupted = function() {
  return interrupted;
};
/**
 * Setter for interrupted.
 * @param {boolean} val value to set.
 */
export const setInterrupted = function(val) {
  interrupted = val;
};
apiFunctions.push(['setInterrupted', setInterrupted]);

/**
 * Enum for Blast status
 * @enum {string}
 * @public
 */
export const statusValues = {
  READY: 'ready',
  RUNNING: 'running',
  STOPPED: 'stopped',
  ERROR: 'error',
};

/**
 * Stores the current status of the interpreter, set through {@link setStatus}.
 */
let status = statusValues.READY;

/**
 * Stores functions to be invoked when status changes.
 */
export const onStatusChange = {ready: [], running: [], stopped: [], error: []};

/**
 * Sets the current status of the interpreter.
 * @param {string} newStatus new status.
 */
const setStatus = function(newStatus) {
  if (status !== newStatus) {
    status = newStatus;
    for (const func of onStatusChange[status]) {
      func();
    }
  }
};

/**
 * latest JavaScript code generated by Blast.
 * @type {string}
 * @public
 */
let latestCode = '';

/**
 * Getter for latestCode.
 * @return {string} latestCode
 */
export const getLatestCode = function() {
  return latestCode;
};

/**
 * Instance of runner function.
 * @type {?Function}
 * @private
 */
let runner_ = null;

/**
 * Blast's main workspace.
 * @type {Blockly.workspaceSvg}
 * @public
 */
let workspace = null;

/**
 * Gets the workspace
 * @return {Blockly.Workspace} the workspace
 */
export const getWorkspace = function() {
  return workspace;
};

/**
 * Array containing all interval events.
 * @type {!Array&lt;!Number>}
 */
export const intervalEvents = [];

/**
 * Tracks event blocks currently in the workspace,
 * in order to run indefinately if in case there are any.
 */
export const eventsInWorkspace = [];

/**
 * Stores event handlers of webHID devices, in order to remove them on code completion.
 */
export let deviceEventHandlers = [];

/**
 * Stores functions to invoke to reset, when the interpreter is stopped.
 */
const cleanUpFunctions = [];
export const addCleanUpFunction = function(fn) {
  cleanUpFunctions.push(fn);
};

/**
 * Set to true if the States Interpreter is running.
 */
let statesInterpreterRunning = false;
export const setStatesInterpreterRunning = function(val) {
  statesInterpreterRunning = val;
};

/**
 * Defines the Interpreters standard output.
 */
let stdOut = prompt;
/**
 * Setter for the Interpreter's standard output function.
 * @param {Function} fn the stdEut function.
 * @public
 */
export const setStdOut = function(fn) {
  stdOut = fn;
};

/**
 * Getter for the Interpreter's standard output function.
 * @return {Function} the stdOut function.
 */
export const getStdOut = function() {
  return stdOut;
};

/**
 * Defines the Interpreters standard info output function.
 */
let stdInfo = prompt;
/**
 * Setter for the Interpreter's standard info output function.
 * @param {Function} fn the stdInfo function.
 */
export const setStdInfo = function(fn) {
  stdInfo = fn;
};
/**
 * Getter for the Interpreter's standard info output function.
 * @return {Function} the stdInfo function.
 */
export const getStdInfo = function() {
  return stdInfo;
};


/**
 * Defines the Interpreters standard error output.
 */
let stdErr = prompt;
/**
 * Setter for the Interpreter's standard error output function.
 * @param {Function} fn the stdErr function.
 * @public
 */
export const setStdError = function(fn) {
  stdErr = fn;
};
/**
 * Getter for the Interpreter's standard error output function.
 * @return {Function} the stdErr function.
 */
export const getStdError = function() {
  return stdErr;
};

/**
 * Saves the current clipboard when workspace is disabled to restore it when enabled.
 */
const clipboard = {};

/**
 * removes all event handlers of webHID devices from {@link deviceEventHandlers}
 */
const removeDeviceHandlers = function() {
  for (const handler of deviceEventHandlers) {
    const device = handler.device;
    device.removeEventListener(handler.type, handler.fn);
  }
  deviceEventHandlers = [];
};

/**
 * Clears all interval events.
 */
const clearIntervalEvents = function() {
  for (const event of intervalEvents) {
    clearInterval(event);
  }
  intervalEvents.length = 0;
};

/**
 * Reset the JS Interpreter.
 * @public
 */
export const resetInterpreter = function() {
  interpreter = null;
  if (runner_) {
    clearTimeout(runner_);
    runner_ = null;
  }
  removeDeviceHandlers();
  clearIntervalEvents();
  
  for (const func of cleanUpFunctions) {
    func();
  }
};

/**
 * Stop the JavaScript execution.
 * @public
 */
export const stopJS = function() {
  resetInterpreter();
  setStatus(statusValues.STOPPED);
};

/**
 * Stop execution and adds an error message to the
 * {@link Blast.Ui.messageOutputContainer}.
 * @param {string=} text optional, a custom error text
 * @license https://www.gnu.org/licenses/agpl-3.0.de.html AGPLv3
 */
export const throwError = function(text) {
  if (!text) {
    text = 'Error executing program - See console for details.';
  }

  stdErr(text);
  setStatus(statusValues.ERROR);
  resetInterpreter();
  stdInfo('Execution stopped');
};

/**
 * Generate JavaScript Code for the user's block-program.
 * @public
 */
const generateCode = function() {
  Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
  Blockly.JavaScript.addReservedWords('highlightBlock');
  // Generate JavaScript code and parse it.
  latestCode = '';
  latestCode = Blockly.JavaScript.workspaceToCode(workspace);
};

/**
 * defines an API for the JS Interpreter.
 * @param {!Interpreter} interpreter interpreter object.
 * @param {!Interpreter.Object} globalObject global scope object.
 */
function initApi(interpreter, globalObject) {
  // Add functions of {@link apiFunctions} to the interpreter.
  for (const f of apiFunctions) {
    // Add function name to reserverd words.
    Blockly.JavaScript.addReservedWords(f[0]);
    // Add function to global scope.
    interpreter.setProperty(
        globalObject,
        f[0], // the function name
        interpreter.createNativeFunction(f[1]), // the function
    );
  }

  // Add functions of {@link asyncApiFunctions} to the interpreter.
  for (const f of asyncApiFunctions) {
    interpreter.setProperty(
        globalObject,
        f[0], // the function name
        interpreter.createAsyncFunction(f[1]), // the function
    );
  }
}

/**
 *
 */
export const initInterpreter = function() {
  workspace = Blockly.inject('content_workspace', {
    // grid: {spacing: 25, length: 3, colour: '#ccc', snap: true},
    media: 'media/',
    toolbox: currentToolbox,
    zoom: {controls: true, wheel: true},
  });

  // Load the interpreter now, and upon future changes.
  generateCode();
  workspace.addChangeListener(function(event) {
    if (!(event instanceof Blockly.Events.Ui)) {
      // Something changed. Parser needs to be reloaded.
      generateCode();
    }
  });
};

/**
 * Places a transparent rectangle over the workspace to prevent
 * the user from interacting with the workspace.
 */
const disableWorkspace = function() {
  const workspaceDiv = document.getElementById('content_workspace');
  const rect = document.createElement('div');
  rect.id = 'workspace-disabled';
  rect.style.position = 'absolute';
  rect.style.top = '0';
  rect.style.left = '0';
  rect.style.width = '100%';
  rect.style.height = '100%';
  rect.style.zIndex = '1';
  rect.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
  workspaceDiv.appendChild(rect);
  // de-select current block so that the delete key won't work.
  Blockly.selected = null;
  // Clear Blockly.clipboard_ to prevent the paste key from working.
  // Save current values to restore later.
  clipboard.clipboard_ = Blockly.clipboard_;
  clipboard.clipboardSource_ = Blockly.clipboardSource_;
  clipboard.clipboardXml = Blockly.clipboardXml;
  clipboard.clipboardTypeCounts_ = Blockly.clipboardTypeCounts_;
  // Clear the clipboard.
  Blockly.clipboard_ = null;
  Blockly.clipboardSource_ = null;
  Blockly.clipboardXml = null;
  Blockly.clipboardTypeCounts_ = null;
};

/**
 * Removes the transparent rectangle over the workspace.
 */
const enableWorkspace = function() {
  const workspaceDiv = document.getElementById('content_workspace');
  const rect = document.getElementById('workspace-disabled');
  workspaceDiv.removeChild(rect);
  // Restore the clipboard.
  Blockly.clipboard_ = clipboard.clipboard_;
  Blockly.clipboardSource_ = clipboard.clipboardSource_;
  Blockly.clipboardXml = clipboard.clipboardXml;
  Blockly.clipboardTypeCounts_ = clipboard.clipboardTypeCounts_;
};
onStatusChange.ready.push(enableWorkspace);
onStatusChange.stopped.push(enableWorkspace);
onStatusChange.error.push(enableWorkspace);

/**
 * Execute the user's code.
 * @public
 */
export const runJS = function() {
  setStatus(statusValues.RUNNING);
  stdInfo('execution started');
  disableWorkspace();

  if (interpreter == null) {
    // Begin execution
    interpreter = new Interpreter(latestCode, initApi);

    /**
     * executes {@link latestCode} using {@link interpreter}.
     * @function runner_
     * @memberof Blast#
     */
    runner_ = function() {
      if (interpreter) {
        try {
          if (interrupted) {
            // Execution is currently interrupted, try again later.
            setTimeout(runner_, 1);
          } else {
            const hasMore = interpreter.step();
            if (hasMore) {
              // Execution is currently blocked by some async call.
              // Try again later.
              setTimeout(runner_, 1);
            } else if (statesInterpreterRunning || eventsInWorkspace.length > 0) {
              // eventChecker is running,
              // dont reset UI until stop button is clicked.
            } else {
              // Program is complete.
              setStatus(statusValues.READY);
              stdInfo('execution completed');
              resetInterpreter();
            }
          }
        } catch (error) {
          throwError(error);
          resetInterpreter();
          console.error(error);
        }
      }
    };

    runner_();
  }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#%255B0%255D">[0]</a></li><li><a href="global.html#addBlock">addBlock</a></li><li><a href="global.html#addElementToOutputContainer">addElementToOutputContainer</a></li><li><a href="global.html#addEventCode">addEventCode</a></li><li><a href="global.html#addEventListener">addEventListener</a></li><li><a href="global.html#addMessage">addMessage</a></li><li><a href="global.html#addToLog">addToLog</a></li><li><a href="global.html#addWebBluetoothDevice">addWebBluetoothDevice</a></li><li><a href="global.html#addWebHidDevice">addWebHidDevice</a></li><li><a href="global.html#allConnectedMobile_">allConnectedMobile_</a></li><li><a href="global.html#allStates">allStates</a></li><li><a href="global.html#apiFunctions">apiFunctions</a></li><li><a href="global.html#asyncApiFunctions">asyncApiFunctions</a></li><li><a href="global.html#bindClick">bindClick</a></li><li><a href="global.html#cacheLEScanResults">cacheLEScanResults</a></li><li><a href="global.html#cleanUpFunctions">cleanUpFunctions</a></li><li><a href="global.html#clearIntervalEvents">clearIntervalEvents</a></li><li><a href="global.html#ClearLog">ClearLog</a></li><li><a href="global.html#ClearOutputContainer">ClearOutputContainer</a></li><li><a href="global.html#clipboard">clipboard</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createWebHidButtonHandler">createWebHidButtonHandler</a></li><li><a href="global.html#currentToolbox">currentToolbox</a></li><li><a href="global.html#deviceEventHandlers">deviceEventHandlers</a></li><li><a href="global.html#disableWorkspace">disableWorkspace</a></li><li><a href="global.html#disconnect">disconnect</a></li><li><a href="global.html#enableWorkspace">enableWorkspace</a></li><li><a href="global.html#eventChecker">eventChecker</a></li><li><a href="global.html#eventCode">eventCode</a></li><li><a href="global.html#eventsFlyoutCategory">eventsFlyoutCategory</a></li><li><a href="global.html#eventsInWorkspace">eventsInWorkspace</a></li><li><a href="global.html#eventValues">eventValues</a></li><li><a href="global.html#filename">filename</a></li><li><a href="global.html#findLegalName">findLegalName</a></li><li><a href="global.html#flyoutCategoryBlocksWB">flyoutCategoryBlocksWB</a></li><li><a href="global.html#flyoutCategoryBlocksWHid">flyoutCategoryBlocksWHid</a></li><li><a href="global.html#generateCode">generateCode</a></li><li><a href="global.html#generatePairButtonsMobile_">generatePairButtonsMobile_</a></li><li><a href="global.html#generatePath">generatePath</a></li><li><a href="global.html#getActiveSlot">getActiveSlot</a></li><li><a href="global.html#getAdvertisedTxPower">getAdvertisedTxPower</a></li><li><a href="global.html#getAdvertisingData">getAdvertisingData</a></li><li><a href="global.html#getAdvertisingInterval">getAdvertisingInterval</a></li><li><a href="global.html#getCapabilities">getCapabilities</a></li><li><a href="global.html#getCategory">getCategory</a></li><li><a href="global.html#getCharacteristic">getCharacteristic</a></li><li><a href="global.html#getDefinition">getDefinition</a></li><li><a href="global.html#getDeviceById">getDeviceById</a></li><li><a href="global.html#getInterpreter">getInterpreter</a></li><li><a href="global.html#getInterrupted">getInterrupted</a></li><li><a href="global.html#getLatestCode">getLatestCode</a></li><li><a href="global.html#getLockState">getLockState</a></li><li><a href="global.html#getPrimaryService">getPrimaryService</a></li><li><a href="global.html#getPublicECDHKey">getPublicECDHKey</a></li><li><a href="global.html#getStdError">getStdError</a></li><li><a href="global.html#getStdInfo">getStdInfo</a></li><li><a href="global.html#getStdOut">getStdOut</a></li><li><a href="global.html#getThingsLog">getThingsLog</a></li><li><a href="global.html#getTxPowerLevel">getTxPowerLevel</a></li><li><a href="global.html#getWebBluetoothDevices">getWebBluetoothDevices</a></li><li><a href="global.html#getWebHIDDevices">getWebHIDDevices</a></li><li><a href="global.html#getWorkspace">getWorkspace</a></li><li><a href="global.html#hexStringToArrayBuffer">hexStringToArrayBuffer</a></li><li><a href="global.html#highlightBlock">highlightBlock</a></li><li><a href="global.html#HTTPREQUEST_ERROR">HTTPREQUEST_ERROR</a></li><li><a href="global.html#importPrettify">importPrettify</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initApi">initApi</a></li><li><a href="global.html#initInterpreter">initInterpreter</a></li><li><a href="global.html#initStatesInterpreter">initStatesInterpreter</a></li><li><a href="global.html#initUi">initUi</a></li><li><a href="global.html#interpreter">interpreter</a></li><li><a href="global.html#interrupted">interrupted</a></li><li><a href="global.html#intervalEvents">intervalEvents</a></li><li><a href="global.html#isLEScanRunning">isLEScanRunning</a></li><li><a href="global.html#isNameUsed">isNameUsed</a></li><li><a href="global.html#latestCode">latestCode</a></li><li><a href="global.html#LEScanResults">LEScanResults</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#LINK_ALERT">LINK_ALERT</a></li><li><a href="global.html#messageOutputContainer">messageOutputContainer</a></li><li><a href="global.html#NOT_FOUND_ERROR">NOT_FOUND_ERROR</a></li><li><a href="global.html#onStatusChange">onStatusChange</a></li><li><a href="global.html#optionalServices">optionalServices</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#readHex">readHex</a></li><li><a href="global.html#readNumber">readNumber</a></li><li><a href="global.html#readText">readText</a></li><li><a href="global.html#reconnectCancelHandler_">reconnectCancelHandler_</a></li><li><a href="global.html#removeDeviceHandlers">removeDeviceHandlers</a></li><li><a href="global.html#removeEventCode">removeEventCode</a></li><li><a href="global.html#removeEventListener">removeEventListener</a></li><li><a href="global.html#rename">rename</a></li><li><a href="global.html#requestDevice">requestDevice</a></li><li><a href="global.html#resetFileInput">resetFileInput</a></li><li><a href="global.html#resetInterpreter">resetInterpreter</a></li><li><a href="global.html#resetStateInterpreter">resetStateInterpreter</a></li><li><a href="global.html#resetThings">resetThings</a></li><li><a href="global.html#resetUi">resetUi</a></li><li><a href="global.html#runButton">runButton</a></li><li><a href="global.html#runJS">runJS</a></li><li><a href="global.html#scanBlocks">scanBlocks</a></li><li><a href="global.html#setActiveSlot">setActiveSlot</a></li><li><a href="global.html#setAdvertisedTxPower">setAdvertisedTxPower</a></li><li><a href="global.html#setAdvertisingData">setAdvertisingData</a></li><li><a href="global.html#setAdvertisingInterval">setAdvertisingInterval</a></li><li><a href="global.html#setInterrupted">setInterrupted</a></li><li><a href="global.html#setStatus">setStatus</a></li><li><a href="global.html#setStdError">setStdError</a></li><li><a href="global.html#setStdInfo">setStdInfo</a></li><li><a href="global.html#setStdOut">setStdOut</a></li><li><a href="global.html#setThingsLog">setThingsLog</a></li><li><a href="global.html#setTxPowerLevel">setTxPowerLevel</a></li><li><a href="global.html#startEventChecker">startEventChecker</a></li><li><a href="global.html#startLEScan">startLEScan</a></li><li><a href="global.html#stateInterpreter">stateInterpreter</a></li><li><a href="global.html#statesInterpreterRunning">statesInterpreterRunning</a></li><li><a href="global.html#status">status</a></li><li><a href="global.html#statusContainer">statusContainer</a></li><li><a href="global.html#statusValues">statusValues</a></li><li><a href="global.html#stdErr">stdErr</a></li><li><a href="global.html#stdInfo">stdInfo</a></li><li><a href="global.html#stdOut">stdOut</a></li><li><a href="global.html#stopJS">stopJS</a></li><li><a href="global.html#stopLEScan">stopLEScan</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#tearDown">tearDown</a></li><li><a href="global.html#thingsFlyoutCategory">thingsFlyoutCategory</a></li><li><a href="global.html#thingsLog">thingsLog</a></li><li><a href="global.html#throwError">throwError</a></li><li><a href="global.html#UUIDS">UUIDS</a></li><li><a href="global.html#webBluetoothDevices">webBluetoothDevices</a></li><li><a href="global.html#webHidDevices">webHidDevices</a></li><li><a href="global.html#webHidNames">webHidNames</a></li><li><a href="global.html#workspace">workspace</a></li><li><a href="global.html#writeWithoutResponse">writeWithoutResponse</a></li><li><a href="global.html#writeWithResponse">writeWithResponse</a></li><li><a href="global.html#XML_ERROR">XML_ERROR</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Mon Jan 24 2022 10:04:12 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
