# Contributing to BLAST<!-- omit in toc -->
For detailed guidelines on how to help make BLAST better, please read the corresponding section below.

- [Reporting Bugs](#reporting-bugs)
  - [Before Submitting A Bug Report](#before-submitting-a-bug-report)
  - [Suggesting Enhancements](#suggesting-enhancements)
- [Code Contributions](#code-contributions)
  - [Adding new Things](#adding-new-things)


## Reporting Bugs

This section guides you through submitting a bug report for BLAST. Following these guidelines helps maintainers and the community understand your report :pencil:, reproduce the behavior :computer: :computer:, and find related reports :mag_right:.

### Before Submitting A Bug Report

* **Try using the newest Chrome on Windows**
* **check to see if an [issue exists](https://github.com/wintechis/blast/issues)** already for the change you want to make.

> **Note:** If you find a **Closed** issue that seems like it is the same thing that you're experiencing, open a new issue and include a link to the original issue in the body of your new one.

#### How Do I Submit A (Good) Bug Report?

Bugs are tracked as [GitHub issues](https://guides.github.com/features/issues/). To report one, create an issue on this repository and provide the following information by filling in [the template](). **TODO**

Explain the problem and include additional details to help maintainers reproduce the problem:

* **Use a clear and descriptive title** for the issue to identify the problem.
* **Describe the exact steps which reproduce the problem** in as many details as possible. 
* **Provide specific examples to demonstrate the steps**. If the problem occurs while executing a block program, provide its XML code.
* **Describe the behavior you observed after following the steps** and point out what exactly is the problem with that behavior.
* **Explain which behavior you expected to see instead and why.**

### Suggesting Enhancements

This section guides you through submitting an enhancement suggestion for BLAST, including completely new features and minor improvements to existing functionality. Following these guidelines helps maintainers and the community understand your suggestion :pencil: and find related suggestions :mag_right:.

When you are creating an enhancement suggestion, please [include as many details as possible](#how-do-i-submit-a-good-enhancement-suggestion). Fill in [the template](https://github.com/atom/.github/blob/master/.github/ISSUE_TEMPLATE/feature_request.md), including the steps that you imagine you would take if the feature you're requesting existed.


#### How Do I Submit A (Good) Enhancement Suggestion?

Enhancement suggestions are tracked as [GitHub issues](https://guides.github.com/features/issues/). To create one, open an issue on this repository and provide the following information:

* **Use a clear and descriptive title** for the issue to identify the suggestion.
* **Provide a step-by-step description of the suggested enhancement** in as many details as possible.
* **Describe the current behavior** and **explain which behavior you expected to see instead** and why.
* **Explain why this enhancement would be useful** to most BLAST users.
* **List some other applications where this enhancement exists.**

## Code Contributions
In general when making code contributions follow these steps to get your contribution reviewed:
1. Create a new Branch to implement your contribution in.
2. Follow [Google's JavaScript Style Guide](https://google.github.io/styleguide/javascriptguide.xml)
3. Open a new [pull request](https://github.com/wintechis/blast/pulls) against the `master` branch.
4. When your contribution is ready for review, and linting plus all tests from the GitHub actions succeed, request a review.
5. Complete additional design work, tests or other changes asked by the reviewer
6. Then, when approved, your PR gets merged into the master branch

### Adding new Things
The most common contribution to BLAST probably is adding blocks for a new Thing, usually connected through Bluetooth or USB. This section provides a step-by-step guide on how to do so.

To create blocks for a new thing two files `blocks.js` and `generators.js` have to be created. These should be located in a new directory in `src/things/`. Have a look at the sub-sections below, to learn about them.

> :blue_book: **For example all code of the blocks interacting with the [Ruuvi Tag](https://ruuvi.com/ruuvitag/) is in `src/things/ruuvi_tag/`**

#### blocks.js
This file describe how a block looks and behaves, including the text, the colour, the shape, and what other blocks it can connect to.

Most of this code can be generated by [Blockly's block factory](https://blockly-demo.appspot.com/static/demos/blockfactory/index.html). Generated code by the this tool is enough to get you started. For more detailed information on defining blocks check out [this section of the blocky docs](https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks).

After writing a blocks definition, the block has to be added to the toolbox, by calling `Blast.Toolbox.addBlock`.

> :blue_book: **The definition of a block reading Ruuvi Tag's temperature for example, looks like this:**
> ```JavaScript
> Blockly.Blocks['get_temperature'] = {
>  /**
>   * Block for the temperature property of a Ruuvi Tag.
>   * @this {Blockly.Block}
>   */
>  init: function() {
>    this.appendValueInput('Thing')
>        .setCheck('Thing')
>        .appendField('get temperature of Ruuvi Tag');
>    this.setOutput(true, ['String', 'Number']);
>    this.setColour(255);
>    this.setTooltip('Reads the temperature property of a Ruuvi Tag.');
>    this.setHelpUrl('');
>  },
>};
>
>// Add the block to the toolbox.
>Blast.Toolbox.addBlock('web_speech', 'actions');
>```



#### generators.js
This file determines what happens, when a block gets executed. On execution each block returns a string containing JavaScript code. BLAST then combines all of these code strings to a complete JavaScript application and executes it.
At most times, this string is a method call passing the block's input as parameters. 

> :blue_book: **the [Ruuvi Tag](https://ruuvi.com/ruuvitag/)'s `get_temperature` block for example reads the Thing Identifier plugged into it, and returns a string calling the internal method `getTemperature` using the Thing Identifier as parameter.**
>```JavaScript
>/**
> * Generates JavaScript code for the get_temperature block.
> * @param {Blockly.Block} block the get_temperature block.
> * @returns {String} the generated code.
> */
>Blockly.JavaScript['get_temperature'] = function(block) {
>  const thing = Blockly.JavaScript.valueToCode(
>      block,
>      'Thing',
>      Blockly.JavaScript.ORDER_ATOMIC,
>  );
>  const code = `getTemperature(${thing})`;
>  return [code, Blockly.JavaScript.ORDER_NONE];
>};
>```
> **Note:** The skeleton of this code, like reading a block's input, can be generated by [Blockly's block factory](https://blockly-demo.appspot.com/static/demos/blockfactory/index.html).

If a block returns a method call, of course the called method has to be implemented. Also each method called by blocks has to be added to the API of BLAST's interpreter. This is done by calling either `Blast.asyncApiFunctions.push` or `Blast.apiFunctions.push`. Depending on whether the method is meant to run asynchronously or not.
Methods that are run asynchronously are always called with a callback function as their last parameter, which is to be called when the method has finished. 

> :blue_book: **for example the following adds the `getTemperature` method to BLAST's interpreter API**
> ```Javascript
> const getTemperature = async function(thing, callback) {
>   // function body
>   ...
>   callback()
> };
>
> // add block function to the interpreter's API.
> Blast.asyncApiFunctions.push(['getTemperature', getTemperature]);
> ```

#### Bluetooth communication
In order to communicate with Bluetooth devices, BLAST provides gatt WebBluetooth implementations for `writeWithoutResponse` and `readCharacteristic`. To utilize them, call `Blast.Bluetooth.gatt_writeWithoutResponse` or `Blast.Bluetooth.gatt_read`. See below for their method signature, or browse to `src/blast_webBluetooth.js` to see their complete implementation.

**Blast.Bluetooth.gatt_writeWithoutResponse**
```JavaScript
/**
  * Writes data to Bluetooth device using the gatt protocol.
  * @param {string} id identifier of the device to disconnect from.
  * @param {BluetoothServiceUUID} serviceUUID identifier of the service.
  * @param {BluetoothCharacteristicUUID} characteristcUUID identifier of the characteristic.
  * @param {string} value hex value to write.
  */
Blast.Bluetooth.gatt_writeWithoutResponse = async function(id, serviceUUID, characteristcUUID, value)
```

**Blast.Bluetooth.gatt_read**
```JavaScript
/**
 * Reads data from Bluetooth device using the gatt protocol.
 * @param {string} id identifier of the device to disconnect from.
 * @param {BluetoothServiceUUID} serviceUUID identifier of the service.
 * @param {BluetoothCharacteristicUUID} characteristcUUID identifier of the characteristic.
 * @param {number} timeout time in ms to wait for response.
 * @return {Object} representation of the complete request with response.
 * @public
 */
Blast.Bluetooth.gatt_read = async function(id, serviceUUID, characteristcUUID, timeout)
```

Before writing to or reading from a characteristic, you have to add its gatt service to the `Blast.Bluetooth.optionalServices` array, by invoking `Blast.Bluetooth.optionalServices.push(serviceUUID);`. See below for an example.

```JavaScript
// Add the LED controller's serviceUUID to optinalServices
const serviceUUID = '0000fff0-0000-1000-8000-00805f9b34fb';
Blast.Bluetooth.optionalServices.push(serviceUUID);

/**
 * switches lights of an LED controller via Bluetooth, by writing a value to it.
 * @param {String} mac identifier of the LED controller.
 * @param {String} value the value to write on the LED controller.
 * @param {JSInterpreter.AsyncCallback} callback JS Interpreter callback.
 */
const switchLights = async function(mac, value, callback) {
  const characteristicUUID = '0000fff3-0000-1000-8000-00805f9b34fb';
  await Blast.Bluetooth.gatt_writeWithoutResponse(mac, serviceUUID, characteristicUUID, value);
  callback();
};
// Add switchLights function to the interpreter's API.
Blast.asyncApiFunctions.push(['switchLights', switchLights]);
```